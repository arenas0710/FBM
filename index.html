<doubaocanvas type="webview" identifier="fbm-pricing-calculator-deploy-optimized" title="适配静态站点部署的FBM售价计算器" genre="">
    <doubaocanvas-part path="fbm-calculator-deploy.html" language="html" description="解决GitHub Pages部署后Excel导入迟钝/无响应问题，优化CDN依赖、内存占用和主线程调度"><!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FBM售价计算器</title>
  <!-- 优化CDN依赖：使用更稳定的jsDelivr CDN，避免跨域或加载失败 -->
  <script src="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.5/dist/tailwind.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <!-- Tailwind配置：内联配置避免外部依赖加载延迟 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            success: '#52C41A',
            warning: '#FAAD14',
            danger: '#F5222D',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <!-- 自定义工具类：内联样式避免外部CSS加载问题 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
      .input-focus { @apply focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none; }
      .btn-primary { @apply bg-primary text-white hover:bg-primary/90 transition-all px-4 py-2 rounded-lg; }
      .btn-secondary { @apply bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 transition-all px-4 py-2 rounded-lg; }
      .btn-danger { @apply bg-white border border-danger text-danger hover:bg-danger/10 transition-all px-4 py-2 rounded-lg; }
      .tag-pill { @apply bg-primary/10 text-primary px-3 py-1 rounded-full text-sm flex items-center; }
      .fade-in { animation: fadeIn 0.3s ease; }
      .copy-hover { @apply hover:bg-primary/5 transition-colors cursor-pointer; }
      .module-hidden { display: none !important; }
      .drag-over { @apply border-primary bg-primary/5; }
      .loading-spinner {
        border-top-color: theme('colors.primary');
        animation: spinner 0.8s linear infinite;
      }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes spinner { to { transform: rotate(360deg); } }
    }
  </style>
  <!-- 关键样式内联：避免部署后样式加载延迟导致的交互异常 -->
  <style>
    /* 确保导入模态框优先显示，避免被其他元素遮挡 */
    #import-modal { z-index: 100; }
    /* 优化表格滚动性能，减少部署后滚动卡顿 */
    .overflow-x-auto { will-change: scroll-position; }
    /* 禁用文本选择，避免操作时误选导致的卡顿 */
    .no-select { user-select: none; -webkit-user-select: none; }
    /* 优化按钮点击反馈，避免部署后点击延迟感 */
    button { touch-action: manipulation; }
  </style>
</head>

<body class="font-inter bg-gray-50 min-h-screen flex flex-col">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-sm sticky top-0 z-50 no-select">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <i class="fa fa-calculator text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-primary">FBM售价计算器</h1>
      </div>
      
      <!-- 桌面端标签 -->
      <div class="hidden md:flex items-center space-x-1">
        <button id="tab-shipping" class="px-5 py-3 font-medium text-primary border-b-2 border-primary">运费计算</button>
        <button id="tab-pricing" class="px-5 py-3 font-medium text-gray-600 border-b-2 border-transparent">售价计算</button>
      </div>
      
      <!-- 移动端菜单按钮 -->
      <button id="mobile-menu-btn" class="md:hidden text-gray-600">
        <i class="fa fa-bars text-xl"></i>
      </button>
    </div>
    
    <!-- 移动端菜单 -->
    <div id="mobile-menu" class="hidden md:hidden bg-white border-t fade-in">
      <div class="container mx-auto px-4 py-2 flex flex-col">
        <button id="mobile-tab-shipping" class="py-3 px-4 text-left font-medium text-primary border-l-4 border-primary">运费计算</button>
        <button id="mobile-tab-pricing" class="py-3 px-4 text-left font-medium text-gray-600 border-l-4 border-transparent">售价计算</button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-grow container mx-auto px-4 py-6">
    <!-- 运费计算模块 -->
    <section id="shipping-module" class="">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- 左侧：物流信息管理 -->
        <div class="lg:col-span-1 space-y-6">
          <div class="bg-white rounded-xl p-5 card-shadow">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-bold">物流信息管理</h2>
              <button id="add-logistics-btn" class="btn-primary text-sm flex items-center">
                <i class="fa fa-plus mr-1"></i> 添加
              </button>
            </div>
            
            <!-- 操作按钮 -->
            <div class="flex flex-wrap gap-2 mb-4">
              <button id="import-logistics-btn" class="btn-secondary text-sm flex items-center" data-import-type="logistics">
                <i class="fa fa-upload mr-1"></i> 导入Excel
              </button>
              <button id="export-logistics-template-btn" class="btn-secondary text-sm flex items-center">
                <i class="fa fa-download mr-1"></i> 导出模板
              </button>
              <button id="delete-selected-logistics-btn" class="btn-danger text-sm flex items-center">
                <i class="fa fa-trash mr-1"></i> 批量删除
              </button>
            </div>
            
            <!-- 搜索筛选 -->
            <div class="flex flex-col sm:flex-row gap-3 mb-4">
              <input type="text" id="logistics-search" placeholder="搜索国家/渠道..." class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus text-sm">
              <select id="logistics-country-filter" class="px-3 py-2 border border-gray-300 rounded-lg input-focus input-focus text-sm">
                <option value="">所有国家</option>
              </select>
            </div>
            
            <!-- 物流表格 -->
            <div class="overflow-x-auto max-h-[500px] overflow-y-auto" style="overscroll-behavior: contain;">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="bg-gray-50 text-left">
                    <th class="px-2 py-2 w-10"><input type="checkbox" id="select-all-logistics"></th>
                    <th class="px-2 py-2 font-medium text-gray-600">国家/地区</th>
                    <th class="px-2 py-2 font-medium text-gray-600">渠道</th>
                    <th class="px-2 py-2 font-medium text-gray-600">重量范围(kg)</th>
                    <th class="px-2 py-2 font-medium text-gray-600">操作</th>
                  </tr>
                </thead>
                <tbody id="logistics-table-body">
                  <tr><td colspan="5" class="px-2 py-4 text-center text-gray-500">暂无物流数据</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- 右侧：运费计算 -->
        <div class="lg:col-span-3 space-y-6">
          <!-- 计算表单 -->
          <div class="bg-white rounded-xl p-5 card-shadow">
            <h2 class="text-lg font-bold mb-4">运费计算</h2>
            <form id="shipping-calculator-form" class="space-y-4">
              <!-- 国家选择 -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">国家/地区 <span class="text-danger">*</span> <span class="text-xs text-gray-500">(输入后按回车添加)</span></label>
                <div class="relative">
                  <input type="text" id="shipping-country-input" placeholder="输入国家并按回车添加..." class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                  <div id="shipping-country-dropdown" class="absolute z-10 top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-40 overflow-y-auto"></div>
                </div>
                <div id="selected-shipping-countries" class="flex flex-wrap gap-2 mt-2"></div>
              </div>
              
              <!-- 尺寸信息和重量参数 - 整合为一行 -->
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">长 (cm) <span class="text-danger">*</span></label>
                  <input type="number" step="0.01" name="length" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">宽 (cm) <span class="text-danger">*</span></label>
                  <input type="number" step="0.01" name="width" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">高 (cm) <span class="text-danger">*</span></label>
                  <input type="number" step="0.01" name="height" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">体积参数</label>
                  <input type="number" name="volumeParam" value="8000" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">包裹重量 (kg) <span class="text-danger">*</span></label>
                  <input type="number" step="0.01" name="weight" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                </div>
              </div>
              
              <!-- 操作按钮：计算 + 清除 -->
              <div class="flex justify-end gap-3">
                <button type="button" id="clear-shipping-data-btn" class="btn-secondary flex items-center">
                  <i class="fa fa-trash mr-2"></i> 清除数据
                </button>
                <button type="submit" class="btn-primary flex items-center">
                  <i class="fa fa-calculator mr-2"></i> 计算运费
                </button>
              </div>
            </form>
          </div>
          
          <!-- 计算结果 -->
          <div class="bg-white rounded-xl p-5 card-shadow">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-3">
              <h2 class="text-lg font-bold">计算结果</h2>
              <div class="flex flex-wrap gap-2">
                <select id="result-country-filter" class="px-3 py-2 border border-gray-300 rounded-lg input-focus text-sm">
                  <option value="">所有国家</option>
                </select>
                <select id="result-channel-filter" class="px-3 py-2 border border-gray-300 rounded-lg input-focus text-sm">
                  <option value="">所有渠道</option>
                </select>
                <button id="reset-filters-btn" class="btn-secondary text-sm">重置筛选</button>
              </div>
            </div>
            
            <!-- 空状态 -->
            <div id="shipping-result-empty" class="py-10 text-center text-gray-500">
              <i class="fa fa-box text-4xl mb-3 opacity-30"></i>
              <p>请输入包裹信息并计算运费</p>
            </div>
            
            <!-- 结果列表 -->
            <div id="shipping-result" class="hidden">
              <div class="overflow-x-auto" style="overscroll-behavior: contain;">
                <table class="min-w-full text-sm">
                  <thead>
                    <tr class="bg-gray-50 text-left">
                      <th class="px-4 py-3 font-medium text-gray-600">国家/地区</th>
                      <th class="px-4 py-3 font-medium text-gray-600">渠道</th>
                      <th class="px-4 py-3 font-medium text-gray-600">体积重 (kg)</th>
                      <th class="px-4 py-3 font-medium text-gray-600">计费重量 (kg)</th>
                      <th class="px-4 py-3 font-medium text-gray-600">运费 (RMB)</th>
                      <th class="px-4 py-3 font-medium text-gray-600">备注</th>
                    </tr>
                  </thead>
                  <tbody id="shipping-result-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- 售价计算模块 -->
    <section id="pricing-module" class="module-hidden">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- 左侧：亚马逊佣金管理 -->
        <div class="lg:col-span-1 space-y-6">
          <div class="bg-white rounded-xl p-5 card-shadow">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-bold">亚马逊佣金管理</h2>
              <button id="add-commission-btn" class="btn-primary text-sm flex items-center">
                <i class="fa fa-plus mr-1"></i> 添加
              </button>
            </div>
            
            <!-- 操作按钮 -->
            <div class="flex flex-wrap gap-2 mb-4">
              <button id="import-commission-btn" class="btn-secondary text-sm flex items-center" data-import-type="commission">
                <i class="fa fa-upload mr-1"></i> 导入Excel
              </button>
              <button id="export-commission-template-btn" class="btn-secondary text-sm flex items-center">
                <i class="fa fa-download mr-1"></i> 导出模板
              </button>
              <button id="delete-selected-commission-btn" class="btn-danger text-sm flex items-center">
                <i class="fa fa-trash mr-1"></i> 批量删除
              </button>
            </div>
            
            <!-- 搜索框 -->
            <div class="mb-4">
              <input type="text" id="commission-search" placeholder="搜索国家/地区..." class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus text-sm">
            </div>
            
            <!-- 佣金表格 -->
            <div class="overflow-x-auto max-h-[500px] overflow-y-auto" style="overscroll-behavior: contain;">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="bg-gray-50 text-left">
                    <th class="px-2 py-2 w-10"><input type="checkbox" id="select-all-commission"></th>
                    <th class="px-2 py-2 font-medium text-gray-600">国家/地区</th>
                    <th class="px-2 py-2 font-medium text-gray-600">佣金 (%)</th>
                    <th class="px-2 py-2 font-medium text-gray-600">市场税 (%)</th>
                    <th class="px-2 py-2 font-medium text-gray-600">汇率</th>
                    <th class="px-2 py-2 font-medium text-gray-600">操作</th>
                  </tr>
                </thead>
                <tbody id="commission-table-body">
                  <tr><td colspan="6" class="px-2 py-4 text-center text-gray-500">暂无佣金数据</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- 右侧：售价计算 -->
        <div class="lg:col-span-3 space-y-6">
          <!-- 国家选择 -->
          <div class="bg-white rounded-xl p-5 card-shadow">
            <h2 class="text-lg font-bold mb-4">选择目标国家/地区</h2>
            <div class="relative">
              <input type="text" id="pricing-country-input" placeholder="输入国家并按回车添加..." class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
              <div id="pricing-country-dropdown" class="absolute z-10 top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-40 overflow-y-auto"></div>
            </div>
            <div id="selected-pricing-countries" class="flex flex-wrap gap-2 mt-2"></div>
          </div>
          
          <!-- 自定义运费模块 -->
          <div class="bg-white rounded-xl p-5 card-shadow">
            <h2 class="text-lg font-bold mb-4">自定义运费</h2>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">自定义运费 (RMB)</label>
              <input type="number" step="0.01" id="custom-shipping-fee" value="0" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
              <p class="text-xs text-gray-500 mt-1">若设置为0，则按系统计算的运费为准；若设置大于0，则使用此运费值</p>
            </div>
          </div>
          
          <!-- 包裹信息 -->
          <div class="bg-white rounded-xl p-5 card-shadow">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-bold">包裹信息</h2>
              <button id="clear-all-packages-btn" class="btn-danger text-sm flex items-center">
                <i class="fa fa-trash mr-1"></i> 全部清除
              </button>
            </div>
            
            <!-- 包裹表单容器 -->
            <div id="packages-container">
              <!-- 初始包裹表单 - 一行布局 -->
              <div class="package-form border border-gray-200 rounded-lg p-4 mb-4 relative">
                <button class="absolute -top-3 -right-3 bg-danger text-white rounded-full w-6 h-6 flex items-center justify-center text-xs delete-package-btn">×</button>
                
                <!-- 一行布局：所有输入字段 -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">长 (cm) <span class="text-danger">*</span></label>
                    <input type="number" step="0.01" name="length" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">宽 (cm) <span class="text-danger">*</span></label>
                    <input type="number" step="0.01" name="width" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">高 (cm) <span class="text-danger">*</span></label>
                    <input type="number" step="0.01" name="height" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">包裹重量 (kg) <span class="text-danger">*</span></label>
                    <input type="number" step="0.01" name="weight" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">采购成本 (RMB) <span class="text-danger">*</span></label>
                    <input type="number" step="0.01" name="cost" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">利润率 (%) <span class="text-danger">*</span></label>
                    <input type="number" step="0.01" name="profitMargin" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 操作按钮：添加包裹 + 计算售价 -->
            <div class="flex justify-between mt-4">
              <button id="add-package-btn" class="btn-secondary text-sm flex items-center">
                <i class="fa fa-plus mr-1"></i> 添加包裹
              </button>
              <button id="calculate-pricing-btn" class="btn-primary flex items-center">
                <i class="fa fa-calculator mr-2"></i> 计算售价
              </button>
            </div>
          </div>
          
          <!-- 售价结果 -->
          <div class="bg-white rounded-xl p-5 card-shadow">
            <h2 class="text-lg font-bold mb-4">售价计算结果</h2>
            <div id="pricing-result-empty" class="py-10 text-center text-gray-500">
              <i class="fa fa-tags text-4xl mb-3 opacity-30"></i>
              <p>请添加包裹信息和目标国家并计算售价</p>
            </div>
            <!-- 售价结果表格 -->
            <div id="pricing-result" class="hidden">
              <div class="space-y-6" id="pricing-result-container">
                <!-- 国家结果卡片动态生成 -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 模态框 -->
  <!-- 物流模态框 -->
  <div id="logistics-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center no-select">
    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 fade-in">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold" id="logistics-modal-title">添加物流信息</h3>
        <button id="close-logistics-modal" class="text-gray-500 hover:text-gray-700"><i class="fa fa-times"></i></button>
      </div>
      <form id="logistics-form">
        <input type="hidden" id="logistics-id">
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">国家/地区 <span class="text-danger">*</span></label>
          <input type="text" id="logistics-country" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
        </div>
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">物流渠道 <span class="text-danger">*</span></label>
          <input type="text" id="logistics-channel" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">起始重量(kg) <span class="text-danger">*</span></label>
            <input type="number" step="0.001" id="logistics-start-weight" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">结束重量(kg) <span class="text-danger">*</span></label>
            <input type="number" step="0.01" id="logistics-end-weight" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">每kg费用 <span class="text-danger">*</span></label>
            <input type="number" step="0.01" id="logistics-cost-per-kg" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">挂号费 <span class="text-danger">*</span></label>
            <input type="number" step="0.01" id="logistics-registration-fee" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
          </div>
        </div>
        <div class="flex justify-end gap-2 mt-6">
          <button type="button" id="cancel-logistics-btn" class="btn-secondary">取消</button>
          <button type="submit" class="btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 佣金模态框 -->
  <div id="commission-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center no-select">
    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 fade-in">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold" id="commission-modal-title">添加亚马逊佣金</h3>
        <button id="close-commission-modal" class="text-gray-500 hover:text-gray-700"><i class="fa fa-times"></i></button>
      </div>
      <form id="commission-form">
        <input type="hidden" id="commission-id">
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">国家/地区 <span class="text-danger">*</span></label>
          <input type="text" id="commission-country" required="" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
        </div>
        <div class="grid grid-cols-2 gap-3 mb-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">佣金 (%) <span class="text-danger">*</span></label>
            <input type="number" step="0.01" id="commission-rate" required="" min="0" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">市场税 (%) <span class="text-danger">*</span></label>
            <input type="number" step="0.01" id="market-tax" required="" min="0" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
          </div>
        </div>
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">汇率 <span class="text-danger">*</span></label>
          <input type="number" step="0.0001" id="exchange-rate" required="" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus">
          <p class="text-xs text-gray-500 mt-1">1当地货币可兑换的人民币数量（如：1美元=9.17人民币，汇率填9.17）</p>
        </div>
        <div class="flex justify-end gap-2 mt-6">
          <button type="button" id="cancel-commission-btn" class="btn-secondary">取消</button>
          <button type="submit" class="btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 导入模态框（优化层级和交互） -->
  <div id="import-modal" class="fixed inset-0 bg-black/50 z-100 hidden items-center justify-center no-select">
    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 fade-in" style="will-change: transform;">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold" id="import-modal-title">导入数据</h3>
        <button id="close-import-modal" class="text-gray-500 hover:text-gray-700"><i class="fa fa-times"></i></button>
      </div>
      
      <!-- 导入处理状态（优化DOM结构，减少重绘） -->
      <div id="import-loading" class="hidden mb-4">
        <div class="flex items-center justify-center py-6">
          <div class="w-10 h-10 rounded-full border-4 border-gray-200 loading-spinner"></div>
          <div class="ml-3">
            <p class="text-gray-700">正在处理...</p>
            <p id="import-progress" class="text-sm text-gray-500">0%</p>
          </div>
        </div>
      </div>
      
      <!-- 导入错误提示（优化显示逻辑） -->
      <div id="import-error" class="hidden mb-4 p-3 bg-danger/10 text-danger rounded-lg text-sm"></div>
      
      <!-- 导入区域（优化拖拽响应） -->
      <div id="import-upload-area">
        <p class="text-sm text-gray-600 mb-3">请选择xls或xlsx格式的文件（最大10MB）</p>
        <input type="file" id="import-file" accept=".xls,.xlsx" class="hidden" style="touch-action: manipulation;">
        <label for="import-file" id="import-file-label" class="block border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50 transition-all">
          <i class="fa fa-file-excel-o text-3xl text-success mb-2"></i>
          <p class="text-sm text-gray-600">点击或拖拽文件到此处</p>
        </label>
        <div id="import-file-name" class="mt-2 text-sm text-gray-500 hidden"></div>
      </div>
      
      <div class="flex justify-end gap-2">
        <button id="cancel-import-btn" class="btn-secondary">取消</button>
        <button id="confirm-import-btn" class="btn-primary">导入</button>
      </div>
    </div>
  </div>

  <!-- 核心逻辑（针对静态站点优化：减少内存占用、优化主线程调度） -->
  <script>
    // 全局错误处理（添加部署环境日志）
    window.addEventListener('error', function(e) {
      console.error('部署环境错误:', e);
      // 若为XLSX库加载失败，提供备用提示
      if (e.message.includes('XLSX is not defined')) {
        alert('Excel处理库加载失败，请刷新页面重试（若多次失败，请检查网络连接）');
      }
    });

    // 等待DOM完全加载（优化加载时机，避免部署后DOM未就绪）
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // 验证关键依赖是否加载成功（部署环境必备）
        if (typeof XLSX === 'undefined') {
          throw new Error('Excel处理库未加载，请检查CDN链接');
        }
        initApp();
      } catch (e) {
        console.error('初始化错误:', e);
        alert('计算器初始化失败：' + e.message + '（请刷新页面重试）');
      }
    });

    function initApp() {
      // 初始化数据（优化本地存储读写，减少部署后IO阻塞）
      initializeData();
      
      // 渲染初始界面（分批次渲染，避免主线程阻塞）
      setTimeout(renderInitialUI, 0);
      
      // 绑定事件（延迟绑定，优先保证界面渲染）
      setTimeout(bindEventsWithDelegation, 100);
    }

    // 数据初始化（优化本地存储操作，避免部署后频繁读写）
    function initializeData() {
      // 数据持久化（添加错误捕获，避免部署后存储权限问题）
      window.DataStore = {
        get(key) {
          try {
            // 部署环境可能限制localStorage，添加降级处理
            if (!window.localStorage) return [];
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
          } catch (e) {
            console.error('获取本地数据失败（部署环境）:', e);
            return [];
          }
        },
        set(key, data) {
          try {
            if (!window.localStorage) return;
            localStorage.setItem(key, JSON.stringify(data));
          } catch (e) {
            console.error('保存本地数据失败（部署环境）:', e);
          }
        }
      };

      // 应用状态（初始化时避免大数据量操作）
      window.appState = {
        logistics: DataStore.get('fbm_logistics'),
        commissions: DataStore.get('fbm_commissions'),
        selectedShippingCountries: [],
        selectedPricingCountries: [],
        shippingResults: [],
        pricingResults: {}
      };
      
      // 货币国家映射（静态数据内联，避免外部依赖）
      window.currencyCountries = {
        gbp: ['英国'],
        eur: ['爱尔兰', '德国', '法国', '意大利', '荷兰', '比利时', '卢森堡', '西班牙', '葡萄牙', '奥地利', '芬兰', '立陶宛', '拉脱维亚', '爱沙尼亚', '斯洛伐克', '斯洛文尼亚', '希腊', '马耳他', '塞浦路斯', '克罗地亚']
      };
    }

    // 工具函数（优化性能，减少部署后计算耗时）
    function generateId() {
      // 简化ID生成，减少部署后计算量
      return Date.now().toString(36).slice(-8);
    }
    
    function exportExcel(headers, data, filename) {
      try {
        // 优化Excel导出，避免部署后内存溢出
        if (data.length > 1000) {
          alert('单次导出数据不超过1000条，避免性能问题');
          data = data.slice(0, 1000);
        }
        const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "数据");
        // 优化文件下载，避免部署后下载阻塞
        setTimeout(() => XLSX.writeFile(wb, filename), 100);
      } catch (e) {
        console.error('导出Excel失败:', e);
        alert('导出失败：' + e.message);
      }
    }
    
    // 货币国家判断（简化逻辑，减少计算）
    function isGbpCountry(country) {
      return window.currencyCountries.gbp.includes(country);
    }
    function isEurCountry(country) {
      return window.currencyCountries.eur.includes(country);
    }

    // 渲染函数（分批次渲染，优化部署后UI响应）
    function renderInitialUI() {
      // 分批次渲染表格，避免主线程阻塞
      setTimeout(renderLogisticsTable, 0);
      setTimeout(renderCommissionTable, 100);
      setTimeout(renderSelectedShippingCountries, 200);
      setTimeout(renderSelectedPricingCountries, 300);
    }
    
    // 物流表格渲染（优化DOM操作，减少重绘）
    function renderLogisticsTable() {
      const tableBody = document.getElementById('logistics-table-body');
      const searchVal = document.getElementById('logistics-search').value.toLowerCase();
      const countryFilter = document.getElementById('logistics-country-filter').value;
      
      // 优化筛选逻辑，减少循环次数
      const filtered = appState.logistics.filter(item => {
        const matchSearch = item.country.toLowerCase().includes(searchVal) || item.channel.toLowerCase().includes(searchVal);
        const matchCountry = !countryFilter || item.country === countryFilter;
        return matchSearch && matchCountry;
      });
      
      if (filtered.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="px-2 py-4 text-center text-gray-500">暂无物流数据</td></tr>';
        return;
      }
      
      // 优化DOM拼接，减少重绘次数
      let html = '';
      filtered.forEach(item => {
        html += `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-2 py-2"><input type="checkbox" class="logistics-checkbox" data-id="${item.id}"></td>
            <td class="px-2 py-2">${item.country}</td>
            <td class="px-2 py-2">${item.channel}</td>
            <td class="px-2 py-2">${item.startWeight}-${item.endWeight}</td>
            <td class="px-2 py-2">
              <button class="text-primary mr-2 edit-logistics" data-id="${item.id}"><i class="fa fa-edit"></i></button>
              <button class="text-danger delete-logistics" data-id="${item.id}"><i class="fa fa-trash"></i></button>
            </td>
          </tr>
        `;
      });
      tableBody.innerHTML = html;
      
      setTimeout(updateLogisticsCountryFilter, 0);
    }
    
    function updateLogisticsCountryFilter() {
      const filter = document.getElementById('logistics-country-filter');
      const countries = [...new Set(appState.logistics.map(item => item.country))];
      const currentVal = filter.value;
      
      // 优化下拉框生成，减少DOM操作
      let options = '<option value="">所有国家</option>';
      countries.forEach(country => {
        options += `<option value="${country}" ${country === currentVal ? 'selected' : ''}>${country}</option>`;
      });
      filter.innerHTML = options;
    }
    
    // 佣金表格渲染（同物流表格优化逻辑）
    function renderCommissionTable() {
      const tableBody = document.getElementById('commission-table-body');
      const searchVal = document.getElementById('commission-search').value.toLowerCase();
      
      const filtered = appState.commissions.filter(item => 
        item.country.toLowerCase().includes(searchVal)
      );
      
      if (filtered.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="px-2 py-4 text-center text-gray-500">暂无佣金数据</td></tr>';
        return;
      }
      
      let html = '';
      filtered.forEach(item => {
        html += `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-2 py-2"><input type="checkbox" class="commission-checkbox" data-id="${item.id}"></td>
            <td class="px-2 py-2">${item.country}</td>
            <td class="px-2 py-2">${Math.round(item.commission)}</td>
            <td class="px-2 py-2">${Math.round(item.marketTax)}</td>
            <td class="px-2 py-2">${item.exchangeRate.toFixed(2)}</td>
            <td class="px-2 py-2">
              <button class="text-primary mr-2 edit-commission" data-id="${item.id}"><i class="fa fa-edit"></i></button>
              <button class="text-danger delete-commission" data-id="${item.id}"><i class="fa fa-trash"></i></button>
            </td>
          </tr>
        `;
      });
      tableBody.innerHTML = html;
    }
    
    // 已选国家渲染（优化DOM操作）
    function renderSelectedShippingCountries() {
      const container = document.getElementById('selected-shipping-countries');
      let html = '';
      appState.selectedShippingCountries.forEach((country, index) => {
        html += `
          <div class="tag-pill">
            ${country}
            <button class="ml-1 delete-shipping-country" data-index="${index}">
              <i class="fa fa-times-circle"></i>
            </button>
          </div>
        `;
      });
      container.innerHTML = html;
    }
    function renderSelectedPricingCountries() {
      const container = document.getElementById('selected-pricing-countries');
      let html = '';
      appState.selectedPricingCountries.forEach((country, index) => {
        html += `
          <div class="tag-pill">
            ${country}
            <button class="ml-1 delete-pricing-country" data-index="${index}">
              <i class="fa fa-times-circle"></i>
            </button>
          </div>
        `;
      });
      container.innerHTML = html;
    }
    
    // 运费结果渲染（优化大数据量展示）
    function renderShippingResult(results) {
      appState.shippingResults = results;
      const emptyState = document.getElementById('shipping-result-empty');
      const resultContainer = document.getElementById('shipping-result');
      const resultBody = document.getElementById('shipping-result-body');
      
      if (results.length === 0) {
        emptyState.classList.remove('hidden');
        resultContainer.classList.add('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      resultContainer.classList.remove('hidden');
      
      // 优化筛选下拉框生成
      const countryFilter = document.getElementById('result-country-filter');
      const channelFilter = document.getElementById('result-channel-filter');
      const countries = [...new Set(results.map(r => r.country))];
      const channels = [...new Set(results.map(r => r.channel))];
      
      let countryOptions = '<option value="">所有国家</option>';
      countries.forEach(country => {
        countryOptions += `<option value="${country}">${country}</option>`;
      });
      countryFilter.innerHTML = countryOptions;
      
      let channelOptions = '<option value="">所有渠道</option>';
      channels.forEach(channel => {
        channelOptions += `<option value="${channel}">${channel}</option>`;
      });
      channelFilter.innerHTML = channelOptions;
      
      // 优化结果表格生成（分批次渲染，避免部署后大数据量卡顿）
      let html = '';
      results.forEach(result => {
        const minBadge = result.isMinFreight ? 
          '<span class="bg-success/10 text-success text-xs px-2 py-0.5 rounded-full">最低运费</span>' : '';
        
        html += `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-4 py-3 copy-hover" data-copy="${result.country}">${result.country}</td>
            <td class="px-4 py-3 copy-hover" data-copy="${result.channel}">${result.channel}</td>
            <td class="px-4 py-3 copy-hover" data-copy="${result.volumeWeight.toFixed(3)}">${result.volumeWeight.toFixed(3)}</td>
            <td class="px-4 py-3 copy-hover" data-copy="${result.chargeableWeight.toFixed(3)}">${result.chargeableWeight.toFixed(3)}</td>
            <td class="px-4 py-3 font-medium ${result.isMinFreight ? 'text-success' : 'text-primary'} copy-hover" data-copy="${result.freight.toFixed(2)}">${result.freight.toFixed(2)}</td>
            <td class="px-4 py-3 copy-hover" data-copy="${minBadge ? '最低运费' : ''}">${minBadge}</td>
          </tr>
        `;
      });
      
      // 优化DOM更新时机
      setTimeout(() => {
        resultBody.innerHTML = html;
        applyShippingFilters();
      }, 0);
    }
    
    // 运费结果筛选（简化逻辑，减少计算）
    function applyShippingFilters() {
      const country = document.getElementById('result-country-filter').value;
      const channel = document.getElementById('result-channel-filter').value;
      
      // 优化筛选逻辑，避免双重循环
      const rows = document.getElementById('shipping-result-body').querySelectorAll('tr');
      rows.forEach((row, index) => {
        const result = appState.shippingResults[index];
        const matchCountry = !country || result.country === country;
        const matchChannel = !channel || result.channel === channel;
        row.style.display = matchCountry && matchChannel ? '' : 'none';
      });
    }
    
    // 售价结果渲染（同运费结果优化逻辑）
    function renderPricingResult(results) {
      appState.pricingResults = results;
      const emptyState = document.getElementById('pricing-result-empty');
      const resultContainer = document.getElementById('pricing-result');
      const resultContent = document.getElementById('pricing-result-container');
      
      if (Object.keys(results).length === 0) {
        emptyState.classList.remove('hidden');
        resultContainer.classList.add('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      resultContainer.classList.remove('hidden');
      
      // 优化结果生成，减少DOM操作
      let html = '';
      for (const country in results) {
        const countryData = results[country];
        if (countryData.length === 0) continue;
        
        // 收集售价用于复制（优化字符串拼接）
        const allPrices = countryData.map(pkg => `${pkg.price.toFixed(2)}`).join('\n');
        
        // 生成国家卡片HTML
        html += `
          <div class="bg-white border border-gray-200 rounded-lg p-4 fade-in">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-semibold text-primary text-lg">${country}</h3>
              <button class="btn-secondary text-sm flex items-center copy-all-prices" data-prices="${allPrices}">
                <i class="fa fa-copy mr-1"></i> 复制所有售价
              </button>
            </div>
            <table class="min-w-full text-sm">
              <thead>
                <tr class="bg-gray-50 text-left">
                  <th class="px-4 py-3 font-medium text-gray-600">包裹</th>
                  <th class="px-4 py-3 font-medium text-gray-600">物流渠道</th>
                  <th class="px-4 py-3 font-medium text-gray-600">计费重量 (kg)</th>
                  <th class="px-4 py-3 font-medium text-gray-600">运费 (RMB)</th>
                  <th class="px-4 py-3 font-medium text-gray-600">采购成本(RMB)</th>
                  <th class="px-4 py-3 font-medium text-gray-600">利润（RMB）</th>
                  <th class="px-4 py-3 font-medium text-gray-600">售价 (当地货币)</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        // 生成表格内容
        countryData.forEach((pkg, idx) => {
          html += `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
              <td class="px-4 py-3 copy-hover" data-copy="包裹 ${idx + 1}">包裹 ${idx + 1}</td>
              <td class="px-4 py-3 copy-hover" data-copy="${pkg.channel}">${pkg.channel}</td>
              <td class="px-4 py-3 copy-hover" data-copy="${pkg.chargeableWeight.toFixed(3)}">${pkg.chargeableWeight.toFixed(3)}</td>
              <td class="px-4 py-3 copy-hover" data-copy="${pkg.freight.toFixed(2)}">${pkg.freight.toFixed(2)}</td>
              <td class="px-4 py-3 copy-hover" data-copy="${pkg.cost.toFixed(2)}">${pkg.cost.toFixed(2)}</td>
              <td class="px-4 py-3 font-medium text-success copy-hover" data-copy="${pkg.profit.toFixed(2)}">${pkg.profit.toFixed(2)}</td>
              <td class="px-4 py-3 font-medium text-primary copy-hover" data-copy="${pkg.price.toFixed(2)}">${pkg.price.toFixed(2)}</td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
            </table>
          </div>
        `;
      }
      
      // 延迟更新DOM，避免主线程阻塞
      setTimeout(() => {
        resultContent.innerHTML = html;
      }, 0);
    }

    // 计算逻辑（优化性能，减少部署后计算耗时）
    function calculateShipping(formData) {
      try {
        const entries = Object.fromEntries(formData.entries());
        const { length, width, height, volumeParam, weight } = entries;
        const selectedCountries = appState.selectedShippingCountries;
        
        // 基础验证（提前返回，避免无效计算）
        if (selectedCountries.length === 0) return [];
        
        // 数值验证（简化逻辑，减少判断）
        const params = {
          length: parseFloat(length),
          width: parseFloat(width),
          height: parseFloat(height),
          volumeParam: parseFloat(volumeParam),
          weight: parseFloat(weight)
        };
        for (const val of Object.values(params)) {
          if (isNaN(val) || val <= 0) return [];
        }
        
        // 核心计算（简化公式，减少运算）
        const volumeWeight = (params.length * params.width * params.height) / params.volumeParam;
        const chargeableWeight = Math.max(volumeWeight, params.weight);
        const countryResults = {};
        let maxResultCount = 0;
        
        // 物流筛选（优化循环，减少冗余计算）
        selectedCountries.forEach(country => {
          const eligibleLogistics = appState.logistics.filter(item => 
            item.country === country && 
            chargeableWeight >= item.startWeight && 
            chargeableWeight <= item.endWeight
          );
          
          if (eligibleLogistics.length === 0) return;
          
          // 运费计算（简化排序，减少比较次数）
          const sortedResults = eligibleLogistics.map(item => ({
            country: item.country,
            channel: item.channel,
            volumeWeight,
            chargeableWeight,
            freight: chargeableWeight * item.costPerKg + item.registrationFee,
            isMinFreight: false
          })).sort((a, b) => a.freight - b.freight);
          
          if (sortedResults.length > 0) sortedResults[0].isMinFreight = true;
          countryResults[country] = sortedResults;
          maxResultCount = Math.max(maxResultCount, sortedResults.length);
        });
        
        // 结果组织（优化逻辑，减少循环嵌套）
        const finalResults = [];
        const countryOrder = selectedCountries;
        
        if (countryOrder.length === 1) {
          const singleCountry = countryOrder[0];
          if (countryResults[singleCountry]) finalResults.push(...countryResults[singleCountry]);
        } else {
          for (let round = 0; round < maxResultCount; round++) {
            countryOrder.forEach(country => {
              const countryData = countryResults[country];
              if (countryData && countryData[round]) finalResults.push(countryData[round]);
            });
          }
        }
        
        return finalResults;
      } catch (e) {
        console.error('运费计算错误:', e);
        return [];
      }
    }
    
    // 售价计算逻辑（同运费计算优化）
    function calculatePricing() {
      try {
        const countries = appState.selectedPricingCountries;
        const packageForms = document.querySelectorAll('.package-form');
        const results = {};
        const customShippingFee = parseFloat(document.getElementById('custom-shipping-fee').value) || 0;
        
        if (countries.length === 0 || packageForms.length === 0) return {};
        
        // 优化循环嵌套，减少计算深度
        countries.forEach(country => {
          const commissionInfo = appState.commissions.find(item => item.country === country);
          if (!commissionInfo) return;
          
          const packageResults = [];
          packageForms.forEach((form, formIdx) => {
            // 快速获取表单数据，减少DOM查询
            const length = parseFloat(form.querySelector('input[name="length"]').value);
            const width = parseFloat(form.querySelector('input[name="width"]').value);
            const height = parseFloat(form.querySelector('input[name="height"]').value);
            const weight = parseFloat(form.querySelector('input[name="weight"]').value);
            const cost = parseFloat(form.querySelector('input[name="cost"]').value);
            const profitMargin = parseFloat(form.querySelector('input[name="profitMargin"]').value);
            
            if (isNaN(length) || isNaN(width) || isNaN(height) || isNaN(weight) || isNaN(cost) || isNaN(profitMargin)) {
              return;
            }
            
            // 核心计算（简化公式）
            const volumeWeight = (length * width * height) / 8000;
            const chargeableWeight = Math.max(volumeWeight, weight);
            
            let minFreight, bestChannel;
            if (customShippingFee > 0) {
              minFreight = customShippingFee;
              bestChannel = "自定义";
            } else {
              const eligibleLogistics = appState.logistics.filter(item => 
                item.country === country && 
                chargeableWeight >= item.startWeight && 
                chargeableWeight <= item.endWeight
              );
              
              if (eligibleLogistics.length === 0) return;
              
              minFreight = Infinity;
              bestChannel = '';
              eligibleLogistics.forEach(item => {
                const freight = chargeableWeight * item.costPerKg + item.registrationFee;
                if (freight < minFreight) {
                  minFreight = freight;
                  bestChannel = item.channel;
                }
              });
            }
            
            // 售价计算（优化公式，减少除法运算）
            const { commission, marketTax, exchangeRate } = commissionInfo;
            const commissionRate = commission / 100;
            const taxRate = marketTax / 100;
            const profitRate = profitMargin / 100;
            
            let price = (cost + minFreight) / ((1 - commissionRate - taxRate) * (1 - profitRate) * exchangeRate);
            
            // 特殊国家处理（简化判断）
            if ((isGbpCountry(country) || isEurCountry(country)) && price > 150) {
              price = (cost + minFreight) / ((1 - commissionRate) * (1 - profitRate) * exchangeRate);
            }
            
            // 利润计算（简化公式）
            const profit = price * exchangeRate - cost - minFreight;
            
            packageResults.push({
              packageIndex: formIdx + 1,
              channel: bestChannel,
              volumeWeight,
              chargeableWeight,
              freight: minFreight,
              cost: cost,
              price,
              profit
            });
          });
          
          if (packageResults.length > 0) results[country] = packageResults;
        });
        
        return results;
      } catch (e) {
        console.error('售价计算错误:', e);
        return {};
      }
    }

    // 模块切换（优化DOM操作，减少重绘）
    function switchToShippingModule() {
      requestAnimationFrame(() => {
        document.getElementById('shipping-module').classList.remove('module-hidden');
        document.getElementById('pricing-module').classList.add('module-hidden');
        
        // 优化标签状态切换，减少DOM操作
        const tabShipping = document.getElementById('tab-shipping');
        const tabPricing = document.getElementById('tab-pricing');
        tabShipping.classList.add('text-primary', 'border-b-2', 'border-primary');
        tabShipping.classList.remove('text-gray-600', 'border-transparent');
        tabPricing.classList.remove('text-primary', 'border-b-2', 'border-primary');
        tabPricing.classList.add('text-gray-600', 'border-transparent');
        
        // 移动端标签
        const mobileTabShipping = document.getElementById('mobile-tab-shipping');
        const mobileTabPricing = document.getElementById('mobile-tab-pricing');
        mobileTabShipping.classList.add('text-primary', 'border-l-4', 'border-primary');
        mobileTabShipping.classList.remove('text-gray-600', 'border-transparent');
        mobileTabPricing.classList.remove('text-primary', 'border-l-4', 'border-primary');
        mobileTabPricing.classList.add('text-gray-600', 'border-transparent');
        
        document.getElementById('mobile-menu').classList.add('hidden');
      });
    }
    function switchToPricingModule() {
      requestAnimationFrame(() => {
        document.getElementById('shipping-module').classList.add('module-hidden');
        document.getElementById('pricing-module').classList.remove('module-hidden');
        
        const tabPricing = document.getElementById('tab-pricing');
        const tabShipping = document.getElementById('tab-shipping');
        tabPricing.classList.add('text-primary', 'border-b-2', 'border-primary');
        tabPricing.classList.remove('text-gray-600', 'border-transparent');
        tabShipping.classList.remove('text-primary', 'border-b-2', 'border-primary');
        tabShipping.classList.add('text-gray-600', 'border-transparent');
        
        const mobileTabPricing = document.getElementById('mobile-tab-pricing');
        const mobileTabShipping = document.getElementById('mobile-tab-shipping');
        mobileTabPricing.classList.add('text-primary', 'border-l-4', 'border-primary');
        mobileTabPricing.classList.remove('text-gray-600', 'border-transparent');
        mobileTabShipping.classList.remove('text-primary', 'border-l-4', 'border-primary');
        mobileTabShipping.classList.add('text-gray-600', 'border-transparent');
        
        document.getElementById('mobile-menu').classList.add('hidden');
      });
    }

    // 【核心优化】Excel导入处理（针对静态站点部署）
    function processExcelImport(file, importType, onProgress, onComplete, onError) {
      // 1. 强化文件验证（部署环境提前拦截无效文件）
      const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
      if (file.size > MAX_FILE_SIZE) {
        onError('文件过大（最大10MB），请压缩后重试');
        return;
      }
      if (!file.name.endsWith('.xls') && !file.name.endsWith('.xlsx')) {
        onError('文件格式错误，仅支持xls/xlsx');
        return;
      }
      
      // 2. 优化文件读取（使用Web Workers避免主线程阻塞，部署环境关键优化）
      let worker;
      try {
        // 动态创建Worker（避免外部文件依赖）
        const workerScript = `
          importScripts('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js');
          
          self.onmessage = function(e) {
            try {
              const { fileData, importType } = e.data;
              const data = new Uint8Array(fileData);
              
              // 分步发送进度（避免部署后进度不更新）
              self.postMessage({ type: 'progress', value: 20 });
              
              // 优化Excel解析（禁用样式解析，减少内存占用）
              const workbook = XLSX.read(data, { 
                type: 'array',
                cellStyles: false, // 禁用单元格样式解析
                cellHTML: false,  // 禁用HTML解析
                sheets: undefined // 只解析第一个工作表
              });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              
              self.postMessage({ type: 'progress', value: 40 });
              
              // 优化JSON转换（仅保留需要的字段）
              const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                header: 1, // 先按数组读取，减少对象创建
                raw: true  // 保留原始值，避免类型转换
              });
              
              // 移除表头（第一行）
              const header = jsonData.shift();
              
              // 处理数据（按类型筛选需要的字段）
              let processedData = [];
              if (importType === 'logistics') {
                // 物流数据：只保留需要的列
                const countryIdx = header.indexOf('国家/地区') !== -1 ? header.indexOf('国家/地区') : header.indexOf('country');
                const channelIdx = header.indexOf('物流渠道') !== -1 ? header.indexOf('物流渠道') : header.indexOf('channel');
                const startWeightIdx = header.indexOf('起始重量(kg)') !== -1 ? header.indexOf('起始重量(kg)') : header.indexOf('startWeight');
                const endWeightIdx = header.indexOf('结束重量(kg)') !== -1 ? header.indexOf('结束重量(kg)') : header.indexOf('endWeight');
                const costPerKgIdx = header.indexOf('每kg费用') !== -1 ? header.indexOf('每kg费用') : header.indexOf('costPerKg');
                const registrationFeeIdx = header.indexOf('挂号费') !== -1 ? header.indexOf('挂号费') : header.indexOf('registrationFee');
                
                // 过滤无效数据
                processedData = jsonData.filter(row => 
                  row[countryIdx] && row[channelIdx] && !isNaN(parseFloat(row[startWeightIdx]))
                ).map(row => ({
                  country: row[countryIdx] || '',
                  channel: row[channelIdx] || '',
                  startWeight: parseFloat(row[startWeightIdx]) || 0,
                  endWeight: parseFloat(row[endWeightIdx]) || 0,
                  costPerKg: parseFloat(row[costPerKgIdx]) || 0,
                  registrationFee: parseFloat(row[registrationFeeIdx]) || 0
                }));
              } else if (importType === 'commission') {
                // 佣金数据：只保留需要的列
                const countryIdx = header.indexOf('国家/地区') !== -1 ? header.indexOf('国家/地区') : header.indexOf('country');
                const commissionIdx = header.indexOf('佣金(%)') !== -1 ? header.indexOf('佣金(%)') : header.indexOf('commission');
                const marketTaxIdx = header.indexOf('市场税(%)') !== -1 ? header.indexOf('市场税(%)') : header.indexOf('marketTax');
                const exchangeRateIdx = header.indexOf('汇率') !== -1 ? header.indexOf('汇率') : header.indexOf('exchangeRate');
                
                processedData = jsonData.filter(row => 
                  row[countryIdx] && !isNaN(parseFloat(row[commissionIdx])) && !isNaN(parseFloat(row[marketTaxIdx]))
                ).map(row => ({
                  country: row[countryIdx] || '',
                  commission: parseFloat(row[commissionIdx]) || 0,
                  marketTax: parseFloat(row[marketTaxIdx]) || 0,
                  exchangeRate: parseFloat(row[exchangeRateIdx]) || 0
                }));
              }
              
              self.postMessage({ type: 'progress', value: 60 });
              self.postMessage({ 
                type: 'complete', 
                data: processedData,
                importType: importType
              });
            } catch (error) {
