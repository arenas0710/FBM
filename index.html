<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>运费计算工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        neutral: '#64748B',
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .tab-active {
                @apply bg-primary text-white border-primary;
            }
            .content-auto {
                content-visibility: auto;
            }
            .country-tag {
                @apply inline-flex items-center bg-blue-50 text-blue-700 px-2.5 py-0.5 rounded-full text-xs mr-2 mb-2;
            }
            .card-shadow {
                @apply shadow-md hover:shadow-lg transition-shadow duration-300;
            }
            .column-input {
                @apply w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary min-h-[120px] resize-y;
            }
            .column-header {
                @apply font-medium text-gray-700 mb-1 block;
            }
            .editing-breathing-bg {
                animation: breathing 2s ease-in-out infinite;
            }
            @keyframes breathing {
                0% { background-color: rgba(59, 130, 246, 0.05); }
                50% { background-color: rgba(59, 130, 246, 0.1); }
                100% { background-color: rgba(59, 130, 246, 0.05); }
            }
            .rank-section {
                @apply mb-8 border border-gray-200 rounded-lg overflow-hidden;
            }
            .rank-header {
                @apply bg-gray-50 px-4 py-3 border-b border-gray-200 font-medium text-gray-800;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">运费计算工具</h1>
            <p class="text-gray-600">高效管理物流信息与计算运费</p>
        </header>
        
        <!-- 标签页导航 -->
        <div class="border-b border-gray-200 mb-6">
            <div class="flex flex-wrap -mb-px">
                <button id="tab1Btn" class="tab-active py-3 px-5 border-b-2 rounded-t-lg font-medium text-sm transition-all">
                    <i class="fa fa-exchange mr-2"></i>单位转换
                </button>
                <button id="tab2Btn" class="bg-gray-100 text-gray-500 hover:text-gray-700 py-3 px-5 border-b-2 border-transparent hover:border-gray-300 rounded-t-lg font-medium text-sm transition-all">
                    <i class="fa fa-truck mr-2"></i>运费计算
                </button>
                <button id="tab3Btn" class="bg-gray-100 text-gray-500 hover:text-gray-700 py-3 px-5 border-b-2 border-transparent hover:border-gray-300 rounded-t-lg font-medium text-sm transition-all">
                    <i class="fa fa-calculator mr-2"></i>包裹成本计算
                </button>
            </div>
        </div>
        
        <!-- 标签页内容 -->
        <div class="tab-content">
            <!-- 第一个标签页：单位转换 -->
            <div id="tab1Content" class="tab-pane">
                <div class="bg-white rounded-xl p-6 card-shadow mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">单位转换</h2>
                    
                    <!-- 小数位数设置 -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <h3 class="text-gray-700 font-medium mb-3">小数位数设置</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">厘米 (cm) 小数位数</label>
                                <select id="cmDecimals" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                    <option value="0" selected="">0位（整数）</option>
                                    <option value="1">1位小数</option>
                                    <option value="2">2位小数</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">英寸 (in) 小数位数</label>
                                <select id="inDecimals" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                    <option value="0">0位（整数）</option>
                                    <option value="1" selected="">1位小数</option>
                                    <option value="2">2位小数</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 输入区域 -->
                    <div class="mb-6">
                        <label for="dimensions" class="block text-gray-700 font-medium mb-2">
                            请输入尺寸 (每行一个，例如: 45*45cm 或 25x25 in)
                        </label>
                        <textarea id="dimensions" rows="6" placeholder="45*45cm
25x25 in
35*35
17.7x17.7in" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary resize-none"></textarea>
                    </div>
                    
                    <!-- 转换按钮 -->
                    <button id="convertBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md font-medium transition-colors mb-6">
                        <i class="fa fa-exchange mr-2"></i>批量转换
                    </button>
                    
                    <!-- 示例提示 -->
                    <div class="text-sm text-gray-600 mb-6 bg-gray-50 p-3 rounded-lg">
                        <p class="font-medium mb-1">示例输入:</p>
                        <pre class="bg-white p-2 rounded text-xs">45*45cm
25x25 in
35*35
17.7x17.7in</pre>
                        <p class="mt-1">支持每行独立设置单位，未指定单位将默认为厘米(cm)</p>
                    </div>
                    
                    <!-- 结果显示区域 -->
                    <div id="resultContainer" class="hidden mt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fa fa-check-circle text-secondary mr-2"></i>转换结果
                        </h3>
                        
                        <!-- 列容器 - 三列并排显示 -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- 标准单位列 -->
                            <div class="border border-gray-200 rounded-xl overflow-hidden shadow-sm bg-white">
                                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between font-medium text-gray-800">
                                    <span>标准单位</span>
                                    <button class="copy-button text-primary hover:text-primary/80 cursor-pointer transition-colors" data-column="0" title="复制整列">
                                        <i class="fa fa-copy"></i> 复制列
                                    </button>
                                </div>
                                <div id="combinedColumn" class="p-2 max-h-96 overflow-y-auto">
                                    <!-- 标准单位数据将在这里显示 -->
                                </div>
                            </div>
                            
                            <!-- 原始单位列 -->
                            <div class="border border-gray-200 rounded-xl overflow-hidden shadow-sm bg-white">
                                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between font-medium text-gray-800">
                                    <span>原始单位</span>
                                    <button class="copy-button text-primary hover:text-primary/80 cursor-pointer transition-colors" data-column="1" title="复制整列">
                                        <i class="fa fa-copy"></i> 复制列
                                    </button>
                                </div>
                                <div id="originalColumn" class="p-2 max-h-96 overflow-y-auto">
                                    <!-- 原始单位数据将在这里显示 -->
                                </div>
                            </div>
                            
                            <!-- 转换单位列 -->
                            <div class="border border-gray-200 rounded-xl overflow-hidden shadow-sm bg-white">
                                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between font-medium text-gray-800">
                                    <span>转换单位</span>
                                    <button class="copy-button text-primary hover:text-primary/80 cursor-pointer transition-colors" data-column="2" title="复制整列">
                                        <i class="fa fa-copy"></i> 复制列
                                    </button>
                                </div>
                                <div id="convertedColumn" class="p-2 max-h-96 overflow-y-auto">
                                    <!-- 转换单位数据将在这里显示 -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 错误提示区域 -->
                    <div id="errorContainer" class="hidden mt-6">
                        <div class="bg-red-50 text-red-600 p-4 rounded-lg">
                            <i class="fa fa-exclamation-circle mr-2"></i>
                            <span id="errorMessage">输入格式不正确，请检查后重试</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 第二个标签页：运费计算（左右分栏布局） -->
            <div id="tab2Content" class="tab-pane hidden">
                <div class="bg-white rounded-xl p-6 card-shadow mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">
                        <i class="fa fa-truck mr-2"></i>运费计算
                    </h2>
                    
                    <!-- 左右分栏布局 -->
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <!-- 左侧：物流信息管理模块（占5列） -->
                        <div class="lg:col-span-5 space-y-6">
                            <div class="bg-white rounded-lg border border-gray-200 p-4 card-shadow">
                                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                                    <h3 class="text-lg font-medium text-gray-800">物流信息管理</h3>
                                    <div class="flex gap-2">
                                        <button id="addLogisticsBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md font-medium transition-colors text-sm">
                                            <i class="fa fa-plus mr-1"></i> 添加
                                        </button>
                                        <button id="importExcelBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-medium transition-colors text-sm">
                                            <i class="fa fa-upload mr-1"></i> 导入
                                        </button>
                                        <button id="exportTemplateBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-medium transition-colors text-sm">
                                            <i class="fa fa-download mr-1"></i> 模板
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 物流信息筛选 -->
                                <div class="space-y-4 mb-4">
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1">国家/地区筛选</label>
                                        <select id="countryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                            <option value="">所有国家/地区</option>
                                            <!-- 动态填充 -->
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1">物流渠道筛选</label>
                                        <select id="channelFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                            <option value="">所有渠道</option>
                                            <!-- 动态填充 -->
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1">搜索</label>
                                        <div class="relative">
                                            <input type="text" id="logisticsSearch" placeholder="搜索物流信息..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary pl-9">
                                            <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 物流信息表格 -->
                                <div class="overflow-x-auto max-h-[400px] overflow-y-auto border border-gray-200 rounded-lg">
                                    <table class="min-w-full bg-white">
                                        <thead class="bg-gray-50 sticky top-0 z-10">
                                            <tr>
                                                <th class="py-2 px-3 border-b w-12">
                                                    <input type="checkbox" id="selectAllLogistics">
                                                </th>
                                                <th class="py-2 px-3 border-b text-left text-sm font-medium text-gray-700">国家</th>
                                                <th class="py-2 px-3 border-b text-left text-sm font-medium text-gray-700">渠道</th>
                                                <th class="py-2 px-3 border-b text-left text-sm font-medium text-gray-700">体积参数</th>
                                                <th class="py-2 px-3 border-b text-left text-sm font-medium text-gray-700">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="logisticsTableBody">
                                            <!-- 物流数据将通过JS动态生成 -->
                                            <tr>
                                                <td colspan="5" class="py-4 text-center text-gray-500">暂无物流信息，请添加或导入</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- 批量删除按钮 -->
                                <div class="mt-4 text-right">
                                    <button id="deleteSelectedBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md font-medium transition-colors text-sm" disabled="">
                                        <i class="fa fa-trash mr-1"></i> 批量删除选中
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右侧：运费计算模块（占7列） -->
                        <div class="lg:col-span-7 space-y-6">
                            <div class="bg-white rounded-lg border border-gray-200 p-4 card-shadow">
                                <h3 class="text-lg font-medium text-gray-800 mb-4">运费计算</h3>
                                
                                <!-- 国家/地区选择（所有包裹共用） -->
                                <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                                    <label class="block text-sm text-gray-700 mb-2 editing-breathing-bg">国家/地区（输入后回车添加多个）</label>
                                    <div class="mb-2" id="country-tags-shared">
                                        <!-- 国家标签将在这里显示 -->
                                    </div>
                                    <input type="text" id="country-input-shared" placeholder="输入国家后回车添加" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" autocomplete="off">
                                    <div class="text-xs text-gray-500 mt-1">支持多国家添加，回车确认，所有包裹将共用这些国家</div>
                                </div>
                                
                                <!-- 体积参数（所有包裹共用） -->
                                <div class="mb-6">
                                    <label for="sharedVolumeParam" class="block text-sm text-gray-700 mb-2 editing-breathing-bg">体积参数（所有包裹共用）</label>
                                    <select id="sharedVolumeParam" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                        <option value="5000">5000</option>
                                        <option value="6000">6000</option>
                                        <option value="7000">7000</option>
                                        <option value="8000" selected>8000</option>
                                        <option value="9000">9000</option>
                                        <option value="10000">10000</option>
                                    </select>
                                </div>
                                
                                <!-- 包裹信息输入（列形式） -->
                                <div class="mb-6">
                                    <div class="font-medium text-gray-700 text-sm md:text-base mb-4">包裹信息</div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <!-- 包裹编号列 -->
                                        <div>
                                            <label class="column-header">包裹</label>
                                            <div id="freightPackageNumbers" class="column-input bg-gray-50" readonly>1
2
3</div>
                                        </div>
                                        
                                        <!-- 长x宽列 -->
                                        <div>
                                            <label class="column-header">长x宽(cm)</label>
                                            <textarea id="freightDimensions" class="column-input" placeholder="45x30
50x25
35x30"></textarea>
                                        </div>
                                        
                                        <!-- 高列 -->
                                        <div>
                                            <label class="column-header">高(cm)</label>
                                            <textarea id="freightHeights" class="column-input" placeholder="15
20
10"></textarea>
                                        </div>
                                        
                                        <!-- 重量列 -->
                                        <div>
                                            <label class="column-header">重量(kg)</label>
                                            <textarea id="freightWeights" class="column-input" placeholder="1.2
2.5
0.8"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4 text-sm text-gray-500">
                                        <p><i class="fa fa-info-circle mr-1"></i> 每行代表一个包裹的数据，支持复制粘贴多行数据</p>
                                        <p><i class="fa fa-info-circle mr-1"></i> 高度或重量只有一行时，将自动应用到所有包裹</p>
                                        <p><i class="fa fa-info-circle mr-1"></i> 系统会自动忽略数字和小数点之间的空格</p>
                                    </div>
                                </div>
                                
                                <!-- 计算按钮 -->
                                <button id="calculateFreightBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md font-medium transition-colors mb-6 w-full md:w-auto">
                                    <i class="fa fa-calculator mr-2"></i>计算运费
                                </button>
                                
                                <!-- 计算结果筛选 -->
                                <div class="hidden" id="freightResultFilters">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm text-gray-600 mb-1">国家范围筛选</label>
                                            <select id="resultCountryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                                <option value="">所有国家</option>
                                                <!-- 动态填充 -->
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm text-gray-600 mb-1">物流渠道筛选</label>
                                            <select id="resultChannelFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                                <option value="">所有渠道</option>
                                                <!-- 动态填充 -->
                                            </select>
                                        </div>
                                        <div id="singleCountryFilters" class="hidden">
                                            <label class="block text-sm text-gray-600 mb-1">价格范围筛选</label>
                                            <div class="grid grid-cols-2 gap-2">
                                                <input type="number" id="minPriceFilter" placeholder="最低价格" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                                <input type="number" id="maxPriceFilter" placeholder="最高价格" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right mb-4">
                                        <button id="resetFreightFiltersBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-medium transition-colors text-sm">
                                            <i class="fa fa-refresh mr-1"></i> 重置筛选
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 计算结果区域 -->
                                <div id="freightResultContainer" class="hidden mt-6">
                                    <h3 class="text-lg font-medium text-gray-800 mb-4">
                                        <i class="fa fa-check-circle text-secondary mr-2"></i>运费计算结果
                                    </h3>
                                    
                                    <div id="rankResultsContainer">
                                        <!-- 按排名的结果将在这里显示 -->
                                    </div>
                                </div>
                                
                                <!-- 运费计算错误提示 -->
                                <div id="freightErrorContainer" class="hidden mt-6">
                                    <div class="bg-red-50 text-red-600 p-4 rounded-lg">
                                        <i class="fa fa-exclamation-circle mr-2"></i>
                                        <span id="freightErrorMessage">请填写完整的包裹信息</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 第三个标签页：包裹成本计算 -->
            <div id="tab3Content" class="tab-pane hidden">
                <div class="bg-white rounded-xl p-6 card-shadow mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">
                        <i class="fa fa-box mr-2"></i>包裹成本计算
                    </h2>
                    
                    <!-- 计算参数设置 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                每kg费用设置
                            </label>
                            <div class="flex items-center gap-3">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="shippingCostType" value="fixed" checked="" class="form-radio text-primary">
                                    <span class="ml-2">固定值</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="shippingCostType" value="dynamic" class="form-radio text-primary">
                                    <span class="ml-2">动态值（来自运费计算）</span>
                                </label>
                            </div>
                            <div id="fixedCostContainer" class="mt-2">
                                <input type="number" id="costPerKg" value="60" min="0.01" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary w-40">
                            </div>
                        </div>
                        <div>
                            <label for="volumeParameter" class="block text-gray-700 font-medium mb-2">
                                体积参数 (默认8000)
                            </label>
                            <input type="number" id="volumeParameter" value="8000" min="1" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary w-40">
                        </div>
                    </div>
                    
                    <!-- 包裹数据输入区域（列形式） -->
                    <div class="mb-6">
                        <div class="font-medium text-gray-700 text-sm md:text-base mb-4">包裹信息</div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <!-- 包裹编号列 -->
                            <div>
                                <label class="column-header">包裹</label>
                                <div id="costPackageNumbers" class="column-input bg-gray-50" readonly>1
2
3</div>
                            </div>
                            
                            <!-- 长x宽列 -->
                            <div>
                                <label class="column-header">长x宽(cm)</label>
                                <textarea id="costDimensions" class="column-input" placeholder="45x30
50x25
35x30"></textarea>
                            </div>
                            
                            <!-- 高列 -->
                            <div>
                                <label class="column-header">高(cm)</label>
                                <textarea id="costHeights" class="column-input" placeholder="15
20
10"></textarea>
                            </div>
                            
                            <!-- 重量列 -->
                            <div>
                                <label class="column-header">重量(kg)</label>
                                <textarea id="costWeights" class="column-input" placeholder="1.2
2.5
0.8"></textarea>
                            </div>
                            
                            <!-- 采购成本列 -->
                            <div>
                                <label class="column-header">采购成本(RMB)</label>
                                <textarea id="costPurchaseCosts" class="column-input" placeholder="100
200
150"></textarea>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-sm text-gray-500">
                            <p><i class="fa fa-info-circle mr-1"></i> 每行代表一个包裹的数据，支持复制粘贴多行数据</p>
                            <p><i class="fa fa-info-circle mr-1"></i> 高度或重量只有一行时，将自动应用到所有包裹</p>
                            <p><i class="fa fa-info-circle mr-1"></i> 系统会自动忽略数字和小数点之间的空格</p>
                        </div>
                    </div>
                    
                    <!-- 计算按钮 -->
                    <button id="calculateCostBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md font-medium transition-colors mb-6">
                        <i class="fa fa-calculator mr-2"></i>计算成本
                    </button>
                    
                    <!-- 计算结果区域 -->
                    <div id="costResultContainer" class="hidden mt-6">
                        <h3 class="text-lg font-medium text-gray-800 mb-4">
                            <i class="fa fa-check-circle text-secondary mr-2"></i>计算结果
                        </h3>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="py-3 px-4 border-b text-left text-sm font-medium text-gray-700">包裹</th>
                                        <th class="py-3 px-4 border-b text-left text-sm font-medium text-gray-700">标准单位</th>
                                        <th class="py-3 px-4 border-b text-left text-sm font-medium text-gray-700">抛重 (kg)</th>
                                        <th class="py-3 px-4 border-b text-left text-sm font-medium text-gray-700">计算重量 (kg)</th>
                                        <th class="py-3 px-4 border-b text-left text-sm font-medium text-gray-700">运费 (RMB)</th>
                                        <th class="py-3 px-4 border-b text-left text-sm font-medium text-gray-700">总成本 (RMB)</th>
                                        <th class="py-3 px-4 border-b text-left text-sm font-medium text-gray-700">增加的成本 (RMB)</th>
                                    </tr>
                                </thead>
                                <tbody id="costResultTable">
                                    <!-- 计算结果将在这里显示 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 成本计算错误提示 -->
                    <div id="costErrorContainer" class="hidden mt-6">
                        <div class="bg-red-50 text-red-600 p-4 rounded-lg">
                            <i class="fa fa-exclamation-circle mr-2"></i>
                            <span id="costErrorMessage">请填写完整的包裹信息</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 复制提示 -->
        <div id="copyNotification" class="hidden fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg z-10">
            已复制整列到剪贴板
        </div>
        
        <!-- 物流信息添加弹窗 -->
        <div id="logisticsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg w-full max-w-md p-6 transform transition-all scale-100">
                <h3 class="text-lg font-semibold text-gray-800 mb-4" id="logisticsModalTitle">添加物流信息</h3>
                <form id="logisticsForm">
                    <input type="hidden" id="logisticsId">
                    <div class="mb-4">
                        <label for="country" class="block text-sm text-gray-600 mb-1">国家/地区 <span class="text-red-500">*</span></label>
                        <input type="text" id="country" required="" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label for="channel" class="block text-sm text-gray-600 mb-1">物流渠道 <span class="text-red-500">*</span></label>
                        <input type="text" id="channel" required="" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label for="logisticsVolumeParam" class="block text-sm text-gray-600 mb-1">体积参数 <span class="text-red-500">*</span></label>
                        <input type="number" id="logisticsVolumeParam" required="" min="1" value="8000" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label for="startWeight" class="block text-sm text-gray-600 mb-1">起始重量(kg) <span class="text-red-500">*</span></label>
                        <input type="number" id="startWeight" required="" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label for="endWeight" class="block text-sm text-gray-600 mb-1">结束重量(kg) <span class="text-red-500">*</span></label>
                        <input type="number" id="endWeight" required="" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label for="pricePerKg" class="block text-sm text-gray-600 mb-1">每kg费用 <span class="text-red-500">*</span></label>
                        <input type="number" id="pricePerKg" required="" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    </div>
                    <div class="mb-6">
                        <label for="registrationFee" class="block text-sm text-gray-600 mb-1">挂号费 <span class="text-red-500">*</span></label>
                        <input type="number" id="registrationFee" required="" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" id="cancelLogisticsBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-medium transition-colors">取消</button>
                        <button type="submit" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md font-medium transition-colors">保存</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 导入文件弹窗 -->
        <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg w-full max-w-md p-6 transform transition-all scale-100">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">导入物流信息</h3>
                <p class="text-sm text-gray-600 mb-4">请导入xls或xlsx格式的文件，表头需包含：国家/地区，物流渠道，体积参数，起始重量(kg)，结束重量(kg)，每kg费用，挂号费</p>
                <div class="mb-6">
                    <input type="file" id="excelFile" accept=".xls,.xlsx" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                </div>
                <div class="flex justify-end gap-3">
                    <button id="cancelImportBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-medium transition-colors">取消</button>
                    <button id="confirmImportBtn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md font-medium transition-colors">确认导入</button>
                </div>
            </div>
        </div>
        
        <!-- 页脚 -->
        <footer class="mt-10 text-center text-gray-500 text-sm">
            <p>运费计算工具 © 2023</p>
        </footer>
    </div>

    <script>
        // 全局数据存储
        let logisticsData = [];
        let freightResults = [];
        let sortedFreightResults = {}; // 按国家、包裹和排名组织的结果
        let maxRank = 0; // 最大排名数
        let currentEditingLogisticsId = null;
        // 存储共用的国家列表
        let sharedCountries = [];
        
        // 清理输入中的空格（特别是数字和小数点之间的空格）
        function cleanNumberInput(input) {
            // 首先移除所有空格
            let cleaned = input.replace(/\s+/g, '');
            
            // 确保只有一个小数点
            const dotIndex = cleaned.indexOf('.');
            if (dotIndex !== -1) {
                // 保留第一个小数点，移除其他的
                cleaned = cleaned.substring(0, dotIndex + 1) + 
                          cleaned.substring(dotIndex + 1).replace(/\./g, '');
            }
            
            return cleaned;
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化标签页
            initTabs();
            
            // 初始化单位转换功能
            initUnitConversion();
            
            // 初始化运费计算功能
            initFreightCalculation();
            
            // 初始化包裹成本计算功能
            initPackageCostCalculation();
            
            // 初始化物流信息管理
            initLogisticsManagement();
            
            // 初始化共用国家输入框事件
            initSharedCountryInput();
            
            // 设置标签页切换时的数据同步
            setupTabSync();
            
            // 添加输入事件监听器，用于自动填充包裹编号
            document.getElementById('freightDimensions').addEventListener('input', updateFreightPackageNumbers);
            document.getElementById('costDimensions').addEventListener('input', updateCostPackageNumbers);
        });
        
        // 自动更新运费计算的包裹编号
        function updateFreightPackageNumbers() {
            const dimensions = document.getElementById('freightDimensions').value.trim();
            const lineCount = dimensions === '' ? 0 : dimensions.split('\n').filter(line => line.trim() !== '').length;
            
            if (lineCount > 0) {
                const packageNumbers = Array.from({length: lineCount}, (_, i) => i + 1).join('\n');
                document.getElementById('freightPackageNumbers').value = packageNumbers;
            }
        }
        
        // 自动更新成本计算的包裹编号
        function updateCostPackageNumbers() {
            const dimensions = document.getElementById('costDimensions').value.trim();
            const lineCount = dimensions === '' ? 0 : dimensions.split('\n').filter(line => line.trim() !== '').length;
            
            if (lineCount > 0) {
                const packageNumbers = Array.from({length: lineCount}, (_, i) => i + 1).join('\n');
                document.getElementById('costPackageNumbers').value = packageNumbers;
            }
        }
        
        // 设置标签页之间的数据同步
        function setupTabSync() {
            // 单位转换标签页输入变化时同步到其他标签页
            document.getElementById('dimensions').addEventListener('input', syncFromUnitConversion);
            document.getElementById('convertBtn').addEventListener('click', function() {
                // 转换后也同步数据
                setTimeout(syncFromUnitConversion, 100);
            });
            
            // 运费计算标签页数据变化时同步到成本计算标签页
            document.getElementById('freightHeights').addEventListener('input', syncFromFreightToCost);
            document.getElementById('freightWeights').addEventListener('input', syncFromFreightToCost);
            document.getElementById('freightDimensions').addEventListener('input', syncFromFreightToCost);
        }
        
        // 从单位转换标签页同步数据到其他标签页
        function syncFromUnitConversion() {
            const dimensionsInput = document.getElementById('dimensions');
            const dimensionLines = dimensionsInput.value.trim().split('\n')
                .filter(line => line.trim() !== '')
                .map(line => {
                    // 提取长x宽部分，忽略单位
                    const match = line.match(/^(\d+(\.\d+)?)([x*])(\d+(\.\d+)?)/);
                    return match ? `${match[1]}x${match[4]}` : line;
                });
            
            const lineCount = dimensionLines.length;
            
            // 生成包裹编号
            const packageNumbers = Array.from({length: lineCount}, (_, i) => i + 1).join('\n');
            
            // 同步到运费计算标签页
            document.getElementById('freightPackageNumbers').value = packageNumbers;
            document.getElementById('freightDimensions').value = dimensionLines.join('\n');
            
            // 同步到成本计算标签页
            document.getElementById('costPackageNumbers').value = packageNumbers;
            document.getElementById('costDimensions').value = dimensionLines.join('\n');
        }
        
        // 从运费计算标签页同步数据到成本计算标签页
        function syncFromFreightToCost() {
            // 同步高
            document.getElementById('costHeights').value = document.getElementById('freightHeights').value;
            
            // 同步重量
            document.getElementById('costWeights').value = document.getElementById('freightWeights').value;
            
            // 同步长x宽
            document.getElementById('costDimensions').value = document.getElementById('freightDimensions').value;
            
            // 更新包裹编号
            updateCostPackageNumbers();
        }
        
        // 处理高度和重量的自动填充
        function normalizePackageData(dimensions, heights, weights) {
            // 过滤空行并清理输入
            const validDimensions = dimensions
                .map(line => line.trim())
                .filter(line => line !== '');
                
            const validHeights = heights
                .map(line => cleanNumberInput(line))
                .filter(line => line !== '');
                
            const validWeights = weights
                .map(line => cleanNumberInput(line))
                .filter(line => line !== '');
            
            const rowCount = validDimensions.length;
            
            if (rowCount === 0) {
                return { dimensions: [], heights: [], weights: [], error: "请填写长x宽信息" };
            }
            
            // 处理高度 - 如果只有一行，复制到所有行
            let normalizedHeights = [];
            if (validHeights.length === 1) {
                normalizedHeights = Array(rowCount).fill(validHeights[0]);
            } else if (validHeights.length === rowCount) {
                normalizedHeights = validHeights;
            } else if (validHeights.length === 0) {
                return { dimensions: [], heights: [], weights: [], error: "请填写高度信息" };
            } else {
                return { dimensions: [], heights: [], weights: [], error: `高度行数(${validHeights.length})与长x宽行数(${rowCount})不匹配` };
            }
            
            // 处理重量 - 如果只有一行，复制到所有行
            let normalizedWeights = [];
            if (validWeights.length === 1) {
                normalizedWeights = Array(rowCount).fill(validWeights[0]);
            } else if (validWeights.length === rowCount) {
                normalizedWeights = validWeights;
            } else if (validWeights.length === 0) {
                return { dimensions: [], heights: [], weights: [], error: "请填写重量信息" };
            } else {
                return { dimensions: [], heights: [], weights: [], error: `重量行数(${validWeights.length})与长x宽行数(${rowCount})不匹配` };
            }
            
            return {
                dimensions: validDimensions,
                heights: normalizedHeights,
                weights: normalizedWeights,
                error: null
            };
        }
        
        // 初始化共用国家输入框事件
        function initSharedCountryInput() {
            const countryInput = document.getElementById('country-input-shared');
            
            countryInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && this.value.trim() !== '') {
                    const country = this.value.trim();
                    
                    // 避免重复添加
                    if (!sharedCountries.includes(country)) {
                        sharedCountries.push(country);
                        // 更新国家标签显示
                        updateSharedCountryTags();
                    }
                    
                    // 清空输入框
                    this.value = '';
                    e.preventDefault();
                }
            });
        }
        
        // 更新共用国家标签显示
        function updateSharedCountryTags() {
            const tagsContainer = document.getElementById('country-tags-shared');
            if (!tagsContainer) return;
            
            // 生成新的标签HTML
            const countryTagsHtml = sharedCountries.map((country, tagIndex) => `
                <span class="country-tag">
                    ${country}
                    <button type="button" class="ml-1 text-blue-500 hover:text-blue-700" onclick="removeSharedCountryTag(${tagIndex})">
                        <i class="fa fa-times-circle"></i>
                    </button>
                </span>
            `).join('');
            
            tagsContainer.innerHTML = countryTagsHtml;
        }
        
        // 移除共用国家标签（全局函数，供onclick调用）
        window.removeSharedCountryTag = function(tagIndex) {
            if (sharedCountries[tagIndex]) {
                // 从数组中移除
                sharedCountries.splice(tagIndex, 1);
                // 更新显示
                updateSharedCountryTags();
            }
        }
        
        // 标签页切换功能
        function initTabs() {
            document.getElementById('tab1Btn').addEventListener('click', function() {
                switchTab(1);
            });
            
            document.getElementById('tab2Btn').addEventListener('click', function() {
                switchTab(2);
            });
            
            document.getElementById('tab3Btn').addEventListener('click', function() {
                switchTab(3);
            });
        }
        
        function switchTab(tabIndex) {
            // 隐藏所有标签页内容
            document.getElementById('tab1Content').classList.add('hidden');
            document.getElementById('tab2Content').classList.add('hidden');
            document.getElementById('tab3Content').classList.add('hidden');
            
            // 重置所有标签按钮样式
            document.getElementById('tab1Btn').classList.remove('tab-active');
            document.getElementById('tab1Btn').classList.add('bg-gray-100', 'text-gray-500', 'hover:text-gray-700', 'border-transparent', 'hover:border-gray-300');
            
            document.getElementById('tab2Btn').classList.remove('tab-active');
            document.getElementById('tab2Btn').classList.add('bg-gray-100', 'text-gray-500', 'hover:text-gray-700', 'border-transparent', 'hover:border-gray-300');
            
            document.getElementById('tab3Btn').classList.remove('tab-active');
            document.getElementById('tab3Btn').classList.add('bg-gray-100', 'text-gray-500', 'hover:text-gray-700', 'border-transparent', 'hover:border-gray-300');
            
            // 显示选中的标签页
            document.getElementById(`tab${tabIndex}Content`).classList.remove('hidden');
            document.getElementById(`tab${tabIndex}Btn`).classList.add('tab-active');
            document.getElementById(`tab${tabIndex}Btn`).classList.remove('bg-gray-100', 'text-gray-500', 'hover:text-gray-700', 'border-transparent', 'hover:border-gray-300');
            
            // 切换标签时同步数据
            if (tabIndex === 2 || tabIndex === 3) {
                syncFromUnitConversion();
            }
            if (tabIndex === 3) {
                syncFromFreightToCost();
            }
        }
        
        // 单位转换功能
        function initUnitConversion() {
            // 转换按钮事件
            document.getElementById('convertBtn').addEventListener('click', convertDimensions);
            
            // 小数位数变化时重新转换
            document.getElementById('cmDecimals').addEventListener('change', function() {
                if (document.getElementById('dimensions').value.trim()) {
                    convertDimensions();
                }
            });
            
            document.getElementById('inDecimals').addEventListener('change', function() {
                if (document.getElementById('dimensions').value.trim()) {
                    convertDimensions();
                }
            });
            
            // 支持Ctrl+Enter触发转换
            document.getElementById('dimensions').addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    convertDimensions();
                }
            });
            
            // 列复制功能
            document.querySelectorAll('.copy-button').forEach(button => {
                button.addEventListener('click', function() {
                    const columnIndex = parseInt(this.getAttribute('data-column'));
                    const columnIds = ['combinedColumn', 'originalColumn', 'convertedColumn'];
                    const columnContainer = document.getElementById(columnIds[columnIndex]);
                    
                    if (!columnContainer) return;
                    
                    const columnItems = columnContainer.querySelectorAll('.p-3.border-b.border-gray-100');
                    
                    if (columnItems.length === 0) {
                        alert('没有可复制的内容');
                        return;
                    }
                    
                    const columnContent = Array.from(columnItems).map(item => item.textContent).join('\n');
                    
                    navigator.clipboard.writeText(columnContent).then(() => {
                        const notification = document.getElementById('copyNotification');
                        notification.textContent = '已复制整列到剪贴板';
                        notification.classList.remove('hidden');
                        setTimeout(() => {
                            notification.classList.add('hidden');
                        }, 2000);
                    }).catch(err => {
                        console.error('复制失败:', err);
                        alert('复制失败，请手动复制');
                    });
                });
            });
        }
        
        function cmToIn(cm) {
            return cm / 2.54;
        }
        
        function inToCm(inch) {
            return inch * 2.54;
        }
        
        function formatNumber(num, unit) {
            const cmDecimals = parseInt(document.getElementById('cmDecimals').value);
            const inDecimals = parseInt(document.getElementById('inDecimals').value);
            
            const decimals = unit === 'cm' ? cmDecimals : inDecimals;
            const factor = Math.pow(10, decimals);
            
            return (Math.round(num * factor) / factor).toString();
        }
        
        function convertSingleDimension(input) {
            input = input.trim();
            const regex = /^(\d+(\.\d+)?)([x*])(\d+(\.\d+)?)\s*((cm|in)|)$/i;
            const match = input.match(regex);
            
            if (!match) {
                throw new Error(`格式错误: "${input}"`);
            }
            
            const width = parseFloat(match[1]);
            const height = parseFloat(match[4]);
            const inputUnit = (match[6] || 'cm').toLowerCase();
            const outputUnit = inputUnit === 'cm' ? 'in' : 'cm';
            
            let convertedWidth, convertedHeight;
            
            if (inputUnit === 'cm') {
                convertedWidth = cmToIn(width);
                convertedHeight = cmToIn(height);
            } else {
                convertedWidth = inToCm(width);
                convertedHeight = inToCm(height);
            }
            
            const original = `${formatNumber(width, inputUnit)}x${formatNumber(height, inputUnit)}${inputUnit}`;
            const converted = `${formatNumber(convertedWidth, outputUnit)}x${formatNumber(convertedHeight, outputUnit)}${outputUnit}`;
            const combined = `${original}/${converted}`;
            
            return { combined, original, converted };
        }
        
        function convertDimensions() {
            const input = document.getElementById('dimensions').value.trim();
            const resultContainer = document.getElementById('resultContainer');
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            // 清空之前的结果
            document.getElementById('combinedColumn').innerHTML = '';
            document.getElementById('originalColumn').innerHTML = '';
            document.getElementById('convertedColumn').innerHTML = '';
            
            try {
                if (!input) {
                    throw new Error('请输入至少一个尺寸值');
                }
                
                const lines = input.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length === 0) {
                    throw new Error('请输入有效的尺寸值');
                }
                
                // 处理每一行并按列显示结果
                lines.forEach((line, index) => {
                    try {
                        const { combined, original, converted } = convertSingleDimension(line);
                        
                        // 向标准单位列添加项目
                        const combinedItem = document.createElement('div');
                        combinedItem.className = 'p-3 border-b border-gray-100 last:border-0 hover:bg-gray-50 transition-colors rounded';
                        combinedItem.textContent = combined;
                        document.getElementById('combinedColumn').appendChild(combinedItem);
                        
                        // 向原始单位列添加项目
                        const originalItem = document.createElement('div');
                        originalItem.className = 'p-3 border-b border-gray-100 last:border-0 hover:bg-gray-50 transition-colors rounded';
                        originalItem.textContent = original;
                        document.getElementById('originalColumn').appendChild(originalItem);
                        
                        // 向转换单位列添加项目
                        const convertedItem = document.createElement('div');
                        convertedItem.className = 'p-3 border-b border-gray-100 last:border-0 hover:bg-gray-50 transition-colors rounded';
                        convertedItem.textContent = converted;
                        document.getElementById('convertedColumn').appendChild(convertedItem);
                        
                    } catch (lineError) {
                        throw new Error(`第 ${index + 1} 行: ${lineError.message}`);
                    }
                });
                
                resultContainer.classList.remove('hidden');
                errorContainer.classList.add('hidden');
                
                // 同步数据到其他标签页
                syncFromUnitConversion();
                
            } catch (error) {
                errorMessage.textContent = error.message;
                errorContainer.classList.remove('hidden');
                resultContainer.classList.add('hidden');
            }
        }
        
        // 物流信息管理功能（左侧布局）
        function initLogisticsManagement() {
            // 添加物流信息按钮
            document.getElementById('addLogisticsBtn').addEventListener('click', function() {
                currentEditingLogisticsId = null;
                document.getElementById('logisticsModalTitle').textContent = '添加物流信息';
                document.getElementById('logisticsForm').reset();
                document.getElementById('logisticsVolumeParam').value = 8000;
                document.getElementById('logisticsModal').classList.remove('hidden');
            });
            
            // 取消添加物流信息
            document.getElementById('cancelLogisticsBtn').addEventListener('click', function() {
                document.getElementById('logisticsModal').classList.add('hidden');
            });
            
            // 提交物流信息表单
            document.getElementById('logisticsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const logistics = {
                    id: currentEditingLogisticsId || Date.now().toString(),
                    country: document.getElementById('country').value.trim(),
                    channel: document.getElementById('channel').value.trim(),
                    volumeParam: parseInt(document.getElementById('logisticsVolumeParam').value),
                    startWeight: parseFloat(document.getElementById('startWeight').value),
                    endWeight: parseFloat(document.getElementById('endWeight').value),
                    pricePerKg: parseFloat(document.getElementById('pricePerKg').value),
                    registrationFee: parseFloat(document.getElementById('registrationFee').value)
                };
                
                // 验证数据
                if (logistics.startWeight > logistics.endWeight) {
                    alert('起始重量不能大于结束重量');
                    return;
                }
                
                // 保存数据
                if (currentEditingLogisticsId) {
                    // 更新现有数据
                    const index = logisticsData.findIndex(item => item.id === currentEditingLogisticsId);
                    if (index !== -1) {
                        logisticsData[index] = logistics;
                    }
                } else {
                    // 添加新数据
                    logisticsData.push(logistics);
                }
                
                // 刷新表格
                renderLogisticsTable();
                updateLogisticsFilters();
                
                // 关闭弹窗
                document.getElementById('logisticsModal').classList.add('hidden');
            });
            
            // 导入Excel按钮
            document.getElementById('importExcelBtn').addEventListener('click', function() {
                document.getElementById('excelFile').value = '';
                document.getElementById('importModal').classList.remove('hidden');
            });
            
            // 取消导入
            document.getElementById('cancelImportBtn').addEventListener('click', function() {
                document.getElementById('importModal').classList.add('hidden');
            });
            
            // 确认导入
            document.getElementById('confirmImportBtn').addEventListener('click', importLogisticsFromExcel);
            
            // 导出模板按钮
            document.getElementById('exportTemplateBtn').addEventListener('click', exportLogisticsTemplate);
            
            // 全选/取消全选
            document.getElementById('selectAllLogistics').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.logistics-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateDeleteButtonState();
            });
            
            // 批量删除按钮
            document.getElementById('deleteSelectedBtn').addEventListener('click', function() {
                if (confirm('确定要删除选中的物流信息吗？')) {
                    const checkboxes = document.querySelectorAll('.logistics-checkbox:checked');
                    const idsToDelete = Array.from(checkboxes).map(checkbox => checkbox.value);
                    
                    logisticsData = logisticsData.filter(item => !idsToDelete.includes(item.id));
                    
                    renderLogisticsTable();
                    updateLogisticsFilters();
                    updateDeleteButtonState();
                }
            });
            
            // 物流筛选事件
            document.getElementById('countryFilter').addEventListener('change', renderLogisticsTable);
            document.getElementById('channelFilter').addEventListener('change', renderLogisticsTable);
            document.getElementById('logisticsSearch').addEventListener('input', renderLogisticsTable);
        }
        
        // 左侧表格显示
        function renderLogisticsTable() {
            const tableBody = document.getElementById('logisticsTableBody');
            const countryFilter = document.getElementById('countryFilter').value;
            const channelFilter = document.getElementById('channelFilter').value;
            const searchTerm = document.getElementById('logisticsSearch').value.toLowerCase();
            
            // 筛选数据
            let filteredData = logisticsData;
            
            if (countryFilter) {
                filteredData = filteredData.filter(item => item.country === countryFilter);
            }
            
            if (channelFilter) {
                filteredData = filteredData.filter(item => item.channel === channelFilter);
            }
            
            if (searchTerm) {
                filteredData = filteredData.filter(item => 
                    item.country.toLowerCase().includes(searchTerm) ||
                    item.channel.toLowerCase().includes(searchTerm)
                );
            }
            
            // 渲染表格
            if (filteredData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">暂无物流信息，请添加或导入</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="py-2 px-3 border-b">
                        <input type="checkbox" class="logistics-checkbox" value="${item.id}">
                    </td>
                    <td class="py-2 px-3 border-b">${item.country}</td>
                    <td class="py-2 px-3 border-b">${item.channel}</td>
                    <td class="py-2 px-3 border-b">${item.volumeParam}</td>
                    <td class="py-2 px-3 border-b">
                        <button class="edit-logistics text-primary hover:text-primary/80 mr-2" data-id="${item.id}">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="delete-logistics text-red-500 hover:text-red-600" data-id="${item.id}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // 添加编辑和删除事件
            document.querySelectorAll('.edit-logistics').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const logistics = logisticsData.find(item => item.id === id);
                    
                    if (logistics) {
                        currentEditingLogisticsId = id;
                        document.getElementById('logisticsModalTitle').textContent = '编辑物流信息';
                        document.getElementById('logisticsId').value = logistics.id;
                        document.getElementById('country').value = logistics.country;
                        document.getElementById('channel').value = logistics.channel;
                        document.getElementById('logisticsVolumeParam').value = logistics.volumeParam;
                        document.getElementById('startWeight').value = logistics.startWeight;
                        document.getElementById('endWeight').value = logistics.endWeight;
                        document.getElementById('pricePerKg').value = logistics.pricePerKg;
                        document.getElementById('registrationFee').value = logistics.registrationFee;
                        
                        document.getElementById('logisticsModal').classList.remove('hidden');
                    }
                });
            });
            
            document.querySelectorAll('.delete-logistics').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    if (confirm('确定要删除这条物流信息吗？')) {
                        logisticsData = logisticsData.filter(item => item.id !== id);
                        renderLogisticsTable();
                        updateLogisticsFilters();
                    }
                });
            });
            
            // 添加复选框事件
            document.querySelectorAll('.logistics-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateDeleteButtonState);
            });
        }
        
        function updateLogisticsFilters() {
            // 获取所有唯一的国家和渠道
            const countries = [...new Set(logisticsData.map(item => item.country))].sort();
            const channels = [...new Set(logisticsData.map(item => item.channel))].sort();
            
            // 更新国家筛选下拉框
            const countryFilter = document.getElementById('countryFilter');
            const currentCountryValue = countryFilter.value;
            countryFilter.innerHTML = '<option value="">所有国家/地区</option>';
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                if (country === currentCountryValue) {
                    option.selected = true;
                }
                countryFilter.appendChild(option);
            });
            
            // 更新渠道筛选筛选下拉框
            const channelFilter = document.getElementById('channelFilter');
            const currentChannelValue = channelFilter.value;
            channelFilter.innerHTML = '<option value="">所有渠道</option>';
            
            channels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel;
                option.textContent = channel;
                if (channel === currentChannelValue) {
                    option.selected = true;
                }
                channelFilter.appendChild(option);
            });
        }
        
        function updateDeleteButtonState() {
            const checkedCount = document.querySelectorAll('.logistics-checkbox:checked').length;
            const deleteButton = document.getElementById('deleteSelectedBtn');
            
            if (checkedCount > 0) {
                deleteButton.disabled = false;
            } else {
                deleteButton.disabled = true;
            }
        }
        
        function importLogisticsFromExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择要导入的Excel文件');
                return;
            }
            
            // 验证文件格式
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (fileExtension !== 'xls' && fileExtension !== 'xlsx') {
                alert('请导入xls或xlsx格式的文件');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // 验证表头
                    const requiredHeaders = ['国家/地区', '物流渠道', '体积参数', '起始重量(kg)', '结束重量(kg)', '每kg费用', '挂号费'];
                    const actualHeaders = Object.keys(jsonData[0] || {});
                    
                    const missingHeaders = requiredHeaders.filter(header => 
                        !actualHeaders.some(actual => actual.includes(header))
                    );
                    
                    if (missingHeaders.length > 0) {
                        alert(`导入的文件缺少必要的表头：${missingHeaders.join(', ')}`);
                        return;
                    }
                    
                    // 解析数据
                    const importedData = jsonData.map(item => {
                        // 处理可能的表头名称变化
                        let country = '';
                        let channel = '';
                        let volumeParam = 8000;
                        let startWeight = 0;
                        let endWeight = 0;
                        let pricePerKg = 0;
                        let registrationFee = 0;
                        
                        for (const key in item) {
                            if (key.includes('国家/地区')) country = item[key];
                            if (key.includes('物流渠道')) channel = item[key];
                            if (key.includes('体积参数')) volumeParam = parseFloat(item[key]) || 8000;
                            if (key.includes('起始重量')) startWeight = parseFloat(item[key]) || 0;
                            if (key.includes('结束重量')) endWeight = parseFloat(item[key]) || 0;
                            if (key.includes('每kg费用')) pricePerKg = parseFloat(item[key]) || 0;
                            if (key.includes('挂号费')) registrationFee = parseFloat(item[key]) || 0;
                        }
                        
                        return {
                            id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                            country: country.toString().trim(),
                            channel: channel.toString().trim(),
                            volumeParam: Math.round(volumeParam),
                            startWeight,
                            endWeight,
                            pricePerKg,
                            registrationFee
                        };
                    }).filter(item => item.country && item.channel); // 过滤无效数据
                    
                    if (importedData.length === 0) {
                        alert('未找到有效的物流信息数据');
                        return;
                    }
                    
                    // 添加到现有数据
                    logisticsData = [...logisticsData, ...importedData];
                    
                    // 刷新表格和筛选器
                    renderLogisticsTable();
                    updateLogisticsFilters();
                    
                    // 关闭弹窗
                    document.getElementById('importModal').classList.add('hidden');
                    
                    alert(`成功导入 ${importedData.length} 条物流信息`);
                    
                } catch (error) {
                    console.error('导入失败:', error);
                    alert('导入失败，请检查文件格式是否正确');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function exportLogisticsTemplate() {
            // 创建模板数据
            const templateData = [
                {
                    '国家/地区': '美国',
                    '物流渠道': 'DHL',
                    '体积参数': 8000,
                    '起始重量(kg)': 0,
                    '结束重量(kg)': 2,
                    '每kg费用': 80,
                    '挂号费': 30
                },
                {
                    '国家/地区': '美国',
                    '物流渠道': 'FedEx',
                    '体积参数': 8000,
                    '起始重量(kg)': 0,
                    '结束重量(kg)': 2,
                    '每kg费用': 75,
                    '挂号费': 25
                }
            ];
            
            // 创建工作簿和工作表
            const worksheet = XLSX.utils.json_to_sheet(templateData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, '物流信息模板');
            
            // 导出文件
            XLSX.writeFile(workbook, '物流信息导入模板.xlsx');
        }
        
        // 运费计算功能（列形式输入）
        function initFreightCalculation() {
            // 计算运费按钮事件
            document.getElementById('calculateFreightBtn').addEventListener('click', calculateFreight);
            
            // 重置筛选按钮
            document.getElementById('resetFreightFiltersBtn').addEventListener('click', function() {
                document.getElementById('resultCountryFilter').value = '';
                document.getElementById('resultChannelFilter').value = '';
                document.getElementById('minPriceFilter').value = '';
                document.getElementById('maxPriceFilter').value = '';
                filterFreightResults();
            });
            
            // 结果筛选事件
            document.getElementById('resultCountryFilter').addEventListener('change', filterFreightResults);
            document.getElementById('resultChannelFilter').addEventListener('change', filterFreightResults);
            document.getElementById('minPriceFilter').addEventListener('input', filterFreightResults);
            document.getElementById('maxPriceFilter').addEventListener('input', filterFreightResults);
        }
        
        // 运费计算逻辑
        function calculateFreight() {
            const resultContainer = document.getElementById('freightResultContainer');
            const errorContainer = document.getElementById('freightErrorContainer');
            const errorMessage = document.getElementById('freightErrorMessage');
            const rankContainer = document.getElementById('rankResultsContainer');
            const volumeParam = parseInt(document.getElementById('sharedVolumeParam').value) || 8000;
            
            // 获取列数据
            const dimensions = document.getElementById('freightDimensions').value.trim().split('\n')
                .map(line => line.trim());
                
            const heights = document.getElementById('freightHeights').value.trim().split('\n')
                .map(line => line.trim());
                
            const weights = document.getElementById('freightWeights').value.trim().split('\n')
                .map(line => line.trim());
            
            // 清空之前的结果
            rankContainer.innerHTML = '';
            freightResults = [];
            sortedFreightResults = {};
            maxRank = 0;
            
            try {
                if (logisticsData.length === 0) {
                    throw new Error('请先在左侧添加物流信息');
                }
                
                // 处理高度和重量的自动填充
                const normalizedData = normalizePackageData(dimensions, heights, weights);
                if (normalizedData.error) {
                    throw new Error(normalizedData.error);
                }
                
                // 验证共用国家
                if (sharedCountries.length === 0) {
                    throw new Error('请至少添加一个国家/地区（输入后回车确认）');
                }
                
                // 收集并验证所有包裹数据
                const packages = [];
                for (let i = 0; i < normalizedData.dimensions.length; i++) {
                    const dimension = normalizedData.dimensions[i];
                    const heightStr = normalizedData.heights[i];
                    const weightStr = normalizedData.weights[i];
                    
                    // 清理输入并转换为数值
                    const height = parseFloat(heightStr);
                    const weight = parseFloat(weightStr);
                    
                    // 验证尺寸、高度、重量
                    if (isNaN(height) || height <= 0) {
                        throw new Error(`第 ${i + 1} 行的高度信息无效（原始值: "${heightStr}"）`);
                    }
                    
                    if (isNaN(weight) || weight <= 0) {
                        throw new Error(`第 ${i + 1} 行的重量信息无效（原始值: "${weightStr}"）`);
                    }
                    
                    // 解析长和宽
                    const dimParts = dimension.split(/[x*]/);
                    if (dimParts.length !== 2) {
                        throw new Error(`第 ${i + 1} 行的尺寸格式不正确，请使用 长x宽 格式（例如：45x30）`);
                    }
                    
                    // 清理长宽数据中的空格
                    const lengthStr = cleanNumberInput(dimParts[0]);
                    const widthStr = cleanNumberInput(dimParts[1]);
                    
                    const length = parseFloat(lengthStr);
                    const width = parseFloat(widthStr);
                    
                    if (isNaN(length) || length <= 0 || isNaN(width) || width <= 0) {
                        throw new Error(`第 ${i + 1} 行的尺寸值无效（原始值: "${dimension}"）`);
                    }
                    
                    packages.push({
                        index: i,
                        length: length,
                        width: width,
                        height: height,
                        volumeParam: volumeParam,
                        weight: weight
                    });
                }
                
                // 计算每个包裹的运费
                packages.forEach(pkg => {
                    // 对每个共用国家分别计算
                    sharedCountries.forEach(country => {
                        // 查找匹配的物流信息
                        const matchingLogistics = logisticsData.filter(log => 
                            log.country === country
                        );
                        
                        // 存储该国家该包裹的所有有效运费
                        const countryPackageRates = [];
                        
                        if (matchingLogistics.length === 0) {
                            // 没有匹配的物流信息，添加提示
                            countryPackageRates.push({
                                packageIndex: pkg.index + 1,
                                country: country,
                                channel: '无匹配',
                                volumeWeight: 0,
                                chargeableWeight: 0,
                                freight: 0,
                                note: '未找到匹配的物流信息'
                            });
                        } else {
                            // 计算体积重量
                            const volume = pkg.length * pkg.width * pkg.height;
                            
                            // 对每个匹配的物流渠道计算运费
                            matchingLogistics.forEach(logistics => {
                                const volumeWeight = volume / pkg.volumeParam;
                                // 计费重量取实际重量和体积重量中的较大值
                                const chargeableWeight = Math.max(pkg.weight, volumeWeight);
                                
                                // 检查是否在重量范围内
                                if (chargeableWeight < logistics.startWeight || chargeableWeight > logistics.endWeight) {
                                    countryPackageRates.push({
                                        packageIndex: pkg.index + 1,
                                        country: country,
                                        channel: logistics.channel,
                                        volumeWeight: volumeWeight.toFixed(2),
                                        chargeableWeight: chargeableWeight.toFixed(2),
                                        freight: 0,
                                        note: `超出重量范围 (${logistics.startWeight}-${logistics.endWeight}kg)`
                                    });
                                    return;
                                }
                                
                                // 计算运费
                                const freight = (chargeableWeight * logistics.pricePerKg) + logistics.registrationFee;
                                
                                countryPackageRates.push({
                                    packageIndex: pkg.index + 1,
                                    country: country,
                                    channel: logistics.channel,
                                    volumeWeight: volumeWeight.toFixed(2),
                                    chargeableWeight: chargeableWeight.toFixed(2),
                                    freight: freight.toFixed(2),
                                    note: ''
                                });
                            });
                        }
                        
                        // 按运费排序（忽略有备注的项）
                        countryPackageRates.sort((a, b) => {
                            // 有备注的放后面
                            if (a.note && !b.note) return 1;
                            if (!a.note && b.note) return -1;
                            if (a.note && b.note) return 0;
                            
                            // 按运费升序排列
                            return parseFloat(a.freight) - parseFloat(b.freight);
                        });
                        
                        // 将结果按国家、包裹和排名组织
                        if (!sortedFreightResults[country]) {
                            sortedFreightResults[country] = {};
                        }
                        
                        sortedFreightResults[country][pkg.index + 1] = countryPackageRates;
                        
                        // 更新最大排名数
                        if (countryPackageRates.length > maxRank) {
                            maxRank = countryPackageRates.length;
                        }
                        
                        // 添加到总结果列表
                        freightResults.push(...countryPackageRates);
                    });
                });
                
                // 显示结果（按排名分组）
                renderFreightResultsByRank();
                
                // 显示筛选器
                document.getElementById('freightResultFilters').classList.remove('hidden');
                
                // 更新结果筛选器选项
                updateResultFilters();
                
                // 同步数据到成本计算标签页
                syncFromFreightToCost();
                
                // 显示结果容器，隐藏错误容器
                resultContainer.classList.remove('hidden');
                errorContainer.classList.add('hidden');
                
            } catch (error) {
                errorMessage.textContent = error.message;
                errorContainer.classList.remove('hidden');
                resultContainer.classList.add('hidden');
                document.getElementById('freightResultFilters').classList.add('hidden');
            }
        }
        
        // 按排名渲染运费计算结果
        function renderFreightResultsByRank() {
            const rankContainer = document.getElementById('rankResultsContainer');
            rankContainer.innerHTML = '';
            
            // 为每个排名创建一个结果区域
            for (let rank = 0; rank < maxRank; rank++) {
                const rankSection = document.createElement('div');
                rankSection.className = 'rank-section';
                
                // 排名标题
                const rankHeader = document.createElement('div');
                rankHeader.className = 'rank-header';
                rankHeader.innerHTML = `<i class="fa fa-trophy mr-2 text-accent"></i>第 ${rank + 1} 轮 - 第 ${rank + 1} 低运费`;
                rankSection.appendChild(rankHeader);
                
                // 结果表格
                const tableContainer = document.createElement('div');
                tableContainer.className = 'overflow-x-auto';
                
                const table = document.createElement('table');
                table.className = 'min-w-full bg-white';
                
                // 表头
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr class="bg-gray-50">
                        <th class="py-2 px-3 border-b text-left text-sm font-medium text-gray-700">包裹</th>
                        <th class="py-2 px-3 border-b text-left text-sm font-medium text-gray-700">国家/地区</th>
                        <th class="py-2 px-3 border-b text-left text-sm font-medium text-gray-700">渠道</th>
                        <th class="py-2 px-3 border-b text-left text-sm font-medium text-gray-700">体积重(kg)</th>
                        <th class="py-2 px-3 border-b text-left text-sm font-medium text-gray-700">计费重量(kg)</th>
                        <th class="py-2 px-3 border-b text-left text-sm font-medium text-gray-700">运费(RMB)</th>
                        <th class="py-2 px-3 border-b text-left text-sm font-medium text-gray-700">备注</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // 表格内容
                const tbody = document.createElement('tbody');
                
                // 按国家顺序和包裹顺序添加结果
                sharedCountries.forEach(country => {
                    if (sortedFreightResults[country]) {
                        // 获取该国家的所有包裹索引并按数字排序
                        const packageIndexes = Object.keys(sortedFreightResults[country])
                            .map(Number)
                            .sort((a, b) => a - b);
                            
                        packageIndexes.forEach(packageIndex => {
                            const rates = sortedFreightResults[country][packageIndex];
                            if (rates && rates[rank]) {
                                const result = rates[rank];
                                const row = document.createElement('tr');
                                row.className = 'hover:bg-gray-50';
                                
                                row.innerHTML = `
                                    <td class="py-2 px-3 border-b">${result.packageIndex}</td>
                                    <td class="py-2 px-3 border-b">${result.country}</td>
                                    <td class="py-2 px-3 border-b">${result.channel}</td>
                                    <td class="py-2 px-3 border-b">${result.volumeWeight}</td>
                                    <td class="py-2 px-3 border-b">${result.chargeableWeight}</td>
                                    <td class="py-2 px-3 border-b ${rank === 0 && result.note === '' ? 'bg-green-50 text-green-700 font-medium' : ''}">
                                        ${result.freight > 0 ? '¥' + result.freight : '-'}
                                    </td>
                                    <td class="py-2 px-3 border-b text-gray-600 text-sm">${result.note || '-'}</td>
                                `;
                                
                                tbody.appendChild(row);
                            }
                        });
                    }
                });
                
                // 如果该排名没有数据
                if (tbody.children.length === 0) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = `<td colspan="7" class="py-4 text-center text-gray-500">没有第 ${rank + 1} 低的运费数据</td>`;
                    tbody.appendChild(emptyRow);
                }
                
                table.appendChild(tbody);
                tableContainer.appendChild(table);
                rankSection.appendChild(tableContainer);
                rankContainer.appendChild(rankSection);
            }
        }
        
        // 更新结果筛选器选项
        function updateResultFilters() {
            // 获取所有唯一的国家和渠道
            const countries = [...new Set(freightResults.map(item => item.country))].sort();
            const channels = [...new Set(freightResults.map(item => item.channel))].sort();
            
            // 更新国家筛选下拉框
            const countryFilter = document.getElementById('resultCountryFilter');
            countryFilter.innerHTML = '<option value="">所有国家</option>';
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
            
            // 更新渠道筛选下拉框
            const channelFilter = document.getElementById('resultChannelFilter');
            channelFilter.innerHTML = '<option value="">所有渠道</option>';
            
            channels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel;
                option.textContent = channel;
                channelFilter.appendChild(option);
            });
        }
        
        // 筛选运费计算结果
        function filterFreightResults() {
            // 这里可以实现筛选逻辑，简化起见暂不实现
            alert('筛选功能已重置，如需实现请添加相应逻辑');
            document.getElementById('resultCountryFilter').value = '';
            document.getElementById('resultChannelFilter').value = '';
            document.getElementById('minPriceFilter').value = '';
            document.getElementById('maxPriceFilter').value = '';
        }
        
        // 包裹成本计算功能（列形式输入）
        function initPackageCostCalculation() {
            // 计算成本按钮事件
            document.getElementById('calculateCostBtn').addEventListener('click', calculatePackageCost);
            
            // 运费成本类型切换
            document.querySelectorAll('input[name="shippingCostType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'fixed') {
                        document.getElementById('fixedCostContainer').classList.remove('hidden');
                    } else {
                        document.getElementById('fixedCostContainer').classList.add('hidden');
                    }
                });
            });
        }
        
        // 计算包裹成本
        function calculatePackageCost() {
            const resultContainer = document.getElementById('costResultContainer');
            const errorContainer = document.getElementById('costErrorContainer');
            const errorMessage = document.getElementById('costErrorMessage');
            const resultTable = document.getElementById('costResultTable');
            const volumeParameter = parseInt(document.getElementById('volumeParameter').value) || 8000;
            const costType = document.querySelector('input[name="shippingCostType"]:checked').value;
            let costPerKg = parseFloat(document.getElementById('costPerKg').value) || 0;
            
            // 获取列数据
            const dimensions = document.getElementById('costDimensions').value.trim().split('\n')
                .map(line => line.trim());
                
            const heights = document.getElementById('costHeights').value.trim().split('\n')
                .map(line => line.trim());
                
            const weights = document.getElementById('costWeights').value.trim().split('\n')
                .map(line => line.trim());
                
            const purchaseCosts = document.getElementById('costPurchaseCosts').value.trim().split('\n')
                .map(line => line.trim());
            
            // 清空之前的结果
            resultTable.innerHTML = '';
            
            try {
                // 处理高度和重量的自动填充
                const normalizedData = normalizePackageData(dimensions, heights, weights);
                if (normalizedData.error) {
                    throw new Error(normalizedData.error);
                }
                
                // 验证采购成本
                const validPurchaseCosts = purchaseCosts
                    .map(line => cleanNumberInput(line))
                    .filter(line => line !== '');
                    
                if (validPurchaseCosts.length === 0) {
                    throw new Error("请填写采购成本信息");
                }
                
                // 处理采购成本 - 如果只有一行，复制到所有行
                let normalizedPurchaseCosts = [];
                if (validPurchaseCosts.length === 1) {
                    normalizedPurchaseCosts = Array(normalizedData.dimensions.length).fill(validPurchaseCosts[0]);
                } else if (validPurchaseCosts.length === normalizedData.dimensions.length) {
                    normalizedPurchaseCosts = validPurchaseCosts;
                } else {
                    throw new Error(`采购成本行数(${validPurchaseCosts.length})与长x宽行数(${normalizedData.dimensions.length})不匹配`);
                }
                
                // 如果是动态成本且没有运费计算结果，提示用户
                if (costType === 'dynamic' && freightResults.length === 0) {
                    throw new Error('请先在运费计算标签页计算运费，然后再使用动态成本计算');
                }
                
                // 收集并验证所有包裹数据
                const packages = [];
                for (let i = 0; i < normalizedData.dimensions.length; i++) {
                    const dimension = normalizedData.dimensions[i];
                    const heightStr = normalizedData.heights[i];
                    const weightStr = normalizedData.weights[i];
                    const purchaseCostStr = normalizedPurchaseCosts[i];
                    
                    // 清理输入并转换为数值
                    const height = parseFloat(heightStr);
                    const weight = parseFloat(weightStr);
                    const purchaseCost = parseFloat(purchaseCostStr) || 0;
                    
                    // 验证数据
                    if (isNaN(height) || height <= 0) {
                        throw new Error(`第 ${i + 1} 行的高度信息无效（原始值: "${heightStr}"）`);
                    }
                    
                    if (isNaN(weight) || weight <= 0) {
                        throw new Error(`第 ${i + 1} 行的重量信息无效（原始值: "${weightStr}"）`);
                    }
                    
                    if (isNaN(purchaseCost) || purchaseCost < 0) {
                        throw new Error(`第 ${i + 1} 行的采购成本信息无效（原始值: "${purchaseCostStr}"）`);
                    }
                    
                    // 解析长和宽
                    const dimParts = dimension.split(/[x*]/);
                    if (dimParts.length !== 2) {
                        throw new Error(`第 ${i + 1} 行的尺寸格式不正确，请使用 长x宽 格式（例如：45x30）`);
                    }
                    
                    // 清理长宽数据中的空格
                    const lengthStr = cleanNumberInput(dimParts[0]);
                    const widthStr = cleanNumberInput(dimParts[1]);
                    
                    const length = parseFloat(lengthStr);
                    const width = parseFloat(widthStr);
                    
                    if (isNaN(length) || length <= 0 || isNaN(width) || width <= 0) {
                        throw new Error(`第 ${i + 1} 行的尺寸值无效（原始值: "${dimension}"）`);
                    }
                    
                    packages.push({
                        index: i,
                        length: length,
                        width: width,
                        height: height,
                        weight: weight,
                        purchaseCost: purchaseCost
                    });
                }
                
                // 计算每个包裹的成本
                const packageCosts = [];
                packages.forEach(pkg => {
                    // 计算体积重量
                    const volume = pkg.length * pkg.width * pkg.height;
                    const volumeWeight = volume / volumeParameter;
                    
                    // 计费重量取实际重量和体积重量中的较大值
                    const chargeableWeight = Math.max(pkg.weight, volumeWeight);
                    
                    // 计算运费
                    let shippingCost;
                    
                    if (costType === 'fixed') {
                        // 固定成本
                        shippingCost = chargeableWeight * costPerKg;
                    } else {
                        // 动态成本 - 取该包裹的最低运费
                        const pkgResults = freightResults.filter(result => 
                            result.packageIndex === pkg.index + 1 && result.note === ''
                        );
                        
                        if (pkgResults.length === 0) {
                            throw new Error(`包裹 ${pkg.index + 1} 没有有效的运费计算结果，请先在运费计算标签页计算`);
                        }
                        
                        // 找到最低运费
                        const minFreight = Math.min(...pkgResults.map(r => parseFloat(r.freight)));
                        shippingCost = minFreight;
                    }
                    
                    // 计算总成本
                    const totalCost = pkg.purchaseCost + shippingCost;
                    
                    packageCosts.push({
                        index: pkg.index,
                        length: pkg.length,
                        width: pkg.width,
                        height: pkg.height,
                        volumeWeight: volumeWeight,
                        chargeableWeight: chargeableWeight,
                        shippingCost: shippingCost,
                        purchaseCost: pkg.purchaseCost,
                        totalCost: totalCost
                    });
                });
                
                // 计算增加的成本（基于第一个包裹）
                const firstPackageCost = packageCosts.length > 0 ? packageCosts[0].totalCost : 0;
                
                packageCosts.forEach(pkg => {
                    // 计算增加的成本
                    const additionalCost = pkg.index === 0 ? 0 : pkg.totalCost - firstPackageCost;
                    
                    // 添加到结果表格
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    row.innerHTML = `
                        <td class="py-3 px-4 border-b">${pkg.index + 1}</td>
                        <td class="py-3 px-4 border-b">${pkg.length}x${pkg.width}x${pkg.height}cm</td>
                        <td class="py-3 px-4 border-b">${pkg.volumeWeight.toFixed(2)}</td>
                        <td class="py-3 px-4 border-b">${pkg.chargeableWeight.toFixed(2)}</td>
                        <td class="py-3 px-4 border-b">¥${pkg.shippingCost.toFixed(2)}</td>
                        <td class="py-3 px-4 border-b font-medium">¥${pkg.totalCost.toFixed(2)}</td>
                        <td class="py-3 px-4 border-b ${additionalCost > 0 ? 'text-red-600' : additionalCost < 0 ? 'text-green-600' : 'text-gray-500'}">
                            ${additionalCost > 0 ? '+' : ''}¥${Math.abs(additionalCost).toFixed(2)}
                        </td>
                    `;
                    
                    resultTable.appendChild(row);
                });
                
                // 显示结果容器，隐藏错误容器
                resultContainer.classList.remove('hidden');
                errorContainer.classList.add('hidden');
                
            } catch (error) {
                errorMessage.textContent = error.message;
                errorContainer.classList.remove('hidden');
                resultContainer.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
    